})
one_gene_res1 = lasso_markers(gene_mt=one_gene_mt,
cluster_mt = vecs_lst$cluster_mt,
sample_names=c("rep1"),
keep_positive=TRUE,
background=NULL)
one_gene_top = get_top_mg(one_gene_res1, coef_cutoff = 1)
one_gene_full =get_full_mg(one_gene_res1, coef_cutoff = 0)
test_that("high resolution results in 0 significant genes", {
expect_equal(unique(one_gene_top[one_gene_top$gene == "gene_A",
"top_cluster"]), "NoSig")
expect_equal(unique(one_gene_full[one_gene_full$gene == "gene_A",
"cluster"]), "A")
})
###############################################################################
# test two sample scenario
set.seed(12)
# simulate coordiantes for clusters
df_clA = data.frame(x = rnorm(n=200, mean=20, sd=5),
y = rnorm(n=200, mean=20, sd=5), cluster="A")
df_clB = data.frame(x = rnorm(n=200, mean=100, sd=5),
y = rnorm(n=200, mean=100, sd=5), cluster="B")
clusters = rbind(df_clA, df_clB)
clusters$sample=c(rep("sample1",times=100),rep("sample2",times=100))
# simulate coordiantes for genes
trans_info_sp2 = data.frame(rbind(cbind(x = rnorm(n=100, mean=20, sd=5),
y = rnorm(n=100, mean=20, sd=5),
feature_name="gene_A1"),
cbind(x = rnorm(n=100, mean=20, sd=5),
y = rnorm(n=100, mean=20, sd=5),
feature_name="gene_A2"),
cbind(x = rnorm(n=100, mean=100, sd=5),
y = rnorm(n=100, mean=100, sd=5),
feature_name="gene_B1"),
cbind(x = rnorm(n=100, mean=100, sd=5),
y = rnorm(n=100, mean=100, sd=5),
feature_name="gene_B2")))
trans_info_sp2$x=as.numeric(trans_info_sp2$x)
trans_info_sp2$y=as.numeric(trans_info_sp2$y)
trans_info_sp2$cell_id = paste("cell", 1:nrow(trans_info_sp2), sep="")
# create SpatialExperiment object
sp2_trans_mol <- BumpyMatrix::splitAsBumpyMatrix(
trans_info_sp2[, c("x", "y")],
row = trans_info_sp2$feature_name, col = trans_info_sp2$cell_id )
spe_sp2<- SpatialExperiment(
assays = list(molecules = sp2_trans_mol),sample_id ="sample2" )
w_x =  c(min(floor(min(trans_info$x)),floor(min(trans_info_sp2$x)),
floor(min(clusters$x))),
max(ceiling(max(trans_info$x)),ceiling(max(trans_info_sp2$x)),
ceiling(max(clusters$x))))
w_y =  c(min(floor(min(trans_info$y)),floor(min(trans_info_sp2$y)),
floor(min(clusters$y))),
max(ceiling(max(trans_info$y)),ceiling(max(trans_info_sp2$y)),
ceiling(max(clusters$y))))
twosample = SingleCellExperiment::cbind(spe,spe_sp2)
vecs_lst = get_vectors(x=twosample, sample_names = c("sample1","sample2"),
cluster_info = clusters,
bin_type = "square",
bin_param = c(20,20),
test_genes =c("gene_A1","gene_A2","gene_B1","gene_B2"),
w_x = w_x, w_y=w_y)
#### background
background_sv = create_genesets(x=twosample, sample_names = c("sample1","sample2"),
name_lst=list(dummy_W=c("gene_A1","gene_B1")),
bin_type="square",
bin_param = c(20,20),
w_x = w_x, w_y=w_y,cluster_info = NULL)
set.seed(100)
lasso_res_background = lasso_markers(gene_mt=vecs_lst$gene_mt,
cluster_mt = vecs_lst$cluster_mt,
sample_names=c("sample1","sample2"),
keep_positive=TRUE,
background=background_sv)
top_res <- get_top_mg(lasso_res_background,coef_cutoff = 0)
full_res <- get_full_mg(lasso_res_background,coef_cutoff = 0)
test_that("lasso-two sample with background", {
expect_equal(length(lasso_res_background), 2)
expect_equal(top_res$top_cluster, c("A","A","B","B"))
expect_equal(unique(full_res$cluster), c("A","dummy_W","B"))
expect_error( lasso_markers(gene_mt=vecs_lst$gene_mt,
cluster_mt = vecs_lst$cluster_mt,
sample_names=c("sample3","sample4"),
keep_positive=TRUE,
background=NULL))
})
#######
background_sv_all = create_genesets(x=twosample,
sample_names = c("sample1","sample2"),
name_lst=list(dummy_A1=c("gene_A1"),
dummy_B1=c("gene_B1"),
dummy_A2=c("gene_A2"),
dummy_B2=c("gene_B2")),
bin_type="square",
bin_param = c(20,20),
w_x = w_x, w_y=w_y,
cluster_info = NULL)
lasso_nosig_bg = lasso_markers(gene_mt=vecs_lst$gene_mt,
cluster_mt = vecs_lst$cluster_mt,
sample_names=c("sample1","sample2"),
keep_positive=TRUE,
background=background_sv_all)
top_res_bg <- get_top_mg(lasso_nosig_bg,coef_cutoff = 0)
full_res_bg <- get_full_mg(lasso_nosig_bg,coef_cutoff = 0)
set.seed(989)
rand_cl_mt = matrix(runif(n=1600,min=0, max = 1),
ncol=2,
nrow=nrow(vecs_lst$cluster_mt))
colnames(rand_cl_mt)=colnames(vecs_lst$cluster_mt)[1:2]
rand_cl_mt = as.data.frame(cbind(rand_cl_mt, vecs_lst$cluster_mt[, c(3:4)]))
lasso_nosig_cl = lasso_markers(gene_mt=vecs_lst$gene_mt,
cluster_mt = rand_cl_mt,
sample_names=c("sample1","sample2"),
keep_positive=TRUE,
background=NULL)
top_res_cl <- get_top_mg(lasso_nosig_cl,coef_cutoff = 0)
full_res_cl <- get_full_mg(lasso_nosig_cl,coef_cutoff = 0)
test_that("set gene as NA if no clusters are significant", {
expect_equal(length(lasso_nosig_bg), 2)
expect_equal(unique(top_res_bg$top_cluster), c("NoSig"))
expect_equal(unique(full_res_bg$cluster),
c("dummy_A1","A","dummy_A2","dummy_B1","B","dummy_B2"))
expect_equal(length(lasso_nosig_cl), 2)
expect_equal(unique(top_res_cl$top_cluster), c("NoSig"))
})
packageDir <- "/vast/projects/xenium_5k/jazzPanda"
BiocCheck::BiocCheck(packageDir, 'new-package'=TRUE,"no-check-vignettes"=FALSE )
devtools::check(pkg = packageDir,  cran = TRUE, vignettes = TRUE)
BiocCheck::BiocCheckGitClone(package=packageDir)
library(devtools)
devtools::load_all()
devtools::document()
# Chunk 1: setup
knitr::opts_chunk$set(
echo = TRUE,
message = FALSE,
warning = FALSE
)
# Chunk 2
library(jazzPanda)
library(SpatialExperiment)
library(ggplot2)
library(grid)
library(data.table)
library(dplyr)
library(glmnet)
library(caret)
library(corrplot)
library(igraph)
library(ggraph)
library(ggrepel)
library(gridExtra)
library(utils)
library(spatstat)
library(tidyr)
library(ggpubr)
# Chunk 3
# ggplot style
defined_theme <- theme(strip.text = element_text(size = rel(1)),
strip.background = element_rect(fill = NA,
colour = "black"),
axis.line=element_blank(),
axis.text.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks=element_blank(),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
legend.position="none",
panel.background=element_blank(),
panel.border=element_blank(),
panel.grid.major=element_blank(),
panel.grid.minor=element_blank(),
plot.background=element_blank())
# Chunk 4: load subset of rep1
data(rep1_sub, rep1_clusters, rep1_neg)
rep1_clusters$cluster<-factor(rep1_clusters$cluster,
levels=paste("c",1:8, sep=""))
# record the transcript coordinates for rep1
rep1_transcripts <-BumpyMatrix::unsplitAsDataFrame(molecules(rep1_sub))
rep1_transcripts <- as.data.frame(rep1_transcripts)
colnames(rep1_transcripts) <- c("feature_name","cell_id","x","y")
# record the negative control transcript coordinates for rep1
rep1_nc_data <- BumpyMatrix::unsplitAsDataFrame(molecules(rep1_neg))
rep1_nc_data <- as.data.frame(rep1_nc_data)
colnames(rep1_nc_data) <- c("feature_name","cell_id","x","y","category")
# record all real genes in the data
all_real_genes <- unique(as.character(rep1_transcripts$feature_name))
all_celltypes <- unique(rep1_clusters[,c("anno","cluster")])
# Chunk 5: rep clusters vis
p1<-ggplot(data = rep1_clusters,
aes(x = x, y = y, color=cluster))+
geom_point(position=position_jitterdodge(jitter.width=0,
jitter.height=0), size=0.1)+
scale_y_reverse()+
theme_classic()+
facet_wrap(~sample)+
scale_color_manual(values = c("#FC8D62","#66C2A5" ,"#8DA0CB","#E78AC3",
"#A6D854","skyblue","purple3","#E5C498"))+
guides(color=guide_legend(title="cluster", nrow = 2,
override.aes=list(alpha=1, size=2)))+
theme(axis.text.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks=element_blank(),
panel.spacing = grid::unit(0.5, "lines"),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
legend.position="none",
strip.text = element_text(size = rel(1)))+
xlab("")+
ylab("")
p2<-ggplot(data = rep1_clusters,
aes(x = x, y = y, color=cluster))+
geom_point(position=position_jitterdodge(jitter.width=0,
jitter.height=0), size=0.1)+
facet_wrap(~cluster, nrow = 2)+
scale_y_reverse()+
theme_classic()+
scale_color_manual(values = c("#FC8D62","#66C2A5" ,"#8DA0CB","#E78AC3",
"#A6D854","skyblue","purple3","#E5C498"))+
guides(color=guide_legend(title="cluster", nrow = 1,
override.aes=list(alpha=1, size=4)))+
theme(axis.text.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks=element_blank(),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
panel.spacing = grid::unit(0.5, "lines"),
legend.text = element_text(size=10),
legend.position="none",
legend.title = element_text(size=10),
strip.text = element_text(size = rel(1)))+
xlab("")+
ylab("")
spacer <- patchwork::plot_spacer()
layout_design <- (p1 / spacer) | p2
layout_design <- layout_design +
patchwork::plot_layout(widths = c(1, 4), heights = c(1, 1))
print(layout_design)
# Chunk 6: plot spatial genes
w_x <- c(min(floor(min(rep1_transcripts$x)),
floor(min(rep1_clusters$x))),
max(ceiling(max(rep1_transcripts$x)),
ceiling(max(rep1_clusters$x))))
w_y <- c(min(floor(min(rep1_transcripts$y)),
floor(min(rep1_clusters$y))),
max(ceiling(max(rep1_transcripts$y)),
ceiling(max(rep1_clusters$y))))
# plot transcript detection coordinates
selected_genes <- rep1_transcripts$feature_name == "EPCAM"
loc_mt <- as.data.frame(rep1_transcripts[selected_genes,
c("x","y","feature_name")]%>%distinct())
colnames(loc_mt)<-c("x","y","feature_name")
layout(matrix(c(1, 2, 3), 1, 3, byrow = TRUE))
par(mar=c(5,3,6,3))
plot(loc_mt$x, loc_mt$y, main = "", xlab = "", ylab = "",
pch = 20, col = "maroon4", cex = 0.1,xaxt='n', yaxt='n')
title(main = "EPCAM transcript detection", line = 3)
box()
# plot square binning
curr<-loc_mt[loc_mt[,"feature_name"]=="EPCAM",c("x","y")] %>% distinct()
curr_ppp <- ppp(curr$x,curr$y,w_x, w_y)
vec_quadrat <- quadratcount(curr_ppp, 10,10)
vec_its <- intensity(vec_quadrat, image=TRUE)
par(mar=c(0.01,1, 1, 2))
plot(vec_its, main = "")
title(main = "square binning", line = -2)
# plot hex binning
w <- owin(xrange=w_x, yrange=w_y)
H <- hextess(W=w, 20)
bin_length <- length(H$tiles)
curr<-loc_mt[loc_mt[,"feature_name"]=="EPCAM",c("x","y")] %>% distinct()
curr_ppp <- ppp(curr$x,curr$y,w_x, w_y)
vec_quadrat <- quadratcount(curr_ppp, tess=H)
vec_its <- intensity(vec_quadrat, image=TRUE)
par(mar=c(0.1,1, 1, 2))
plot(vec_its, main = "")
title(main = "hex binning", line = -2)
# Chunk 7: plot spatial clusters
w_x <- c(min(floor(min(rep1_transcripts$x)),
floor(min(rep1_clusters$x))),
max(ceiling(max(rep1_transcripts$x)),
ceiling(max(rep1_clusters$x))))
w_y <-  c(min(floor(min(rep1_transcripts$y)),
floor(min(rep1_clusters$y))),
max(ceiling(max(rep1_transcripts$y)),
ceiling(max(rep1_clusters$y))))
# plot cell coordinates
loc_mt <- as.data.frame(rep1_clusters[rep1_clusters$cluster=="c1",
c("x","y","cluster")])
colnames(loc_mt)=c("x","y","cluster")
layout(matrix(c(1, 2, 3), 1, 3, byrow = TRUE))
par(mar=c(5,3,6,3))
plot(loc_mt$x, loc_mt$y, main = "", xlab = "", ylab = "",
pch = 20, col = "maroon4", cex = 0.1,xaxt='n', yaxt='n')
title(main = "cell coordinates in cluster c1", line = 3)
box()
# plot square binning
curr<-loc_mt[loc_mt[,"cluster"]=="c1", c("x","y")]%>%distinct()
curr_ppp <- ppp(curr$x,curr$y,w_x, w_y)
vec_quadrat <- quadratcount(curr_ppp, 10,10)
vec_its <- intensity(vec_quadrat, image=TRUE)
par(mar=c(0.1,1, 1, 2))
plot(vec_its, main = "")
title(main = "square binning", line = -2)
# plot hex binning
w <- owin(xrange=w_x, yrange=w_y)
H <- hextess(W=w, 20)
bin_length <- length(H$tiles)
curr<-loc_mt[loc_mt[,"cluster"]=="c1",c("x","y")] %>%distinct()
curr_ppp <- ppp(curr$x,curr$y,w_x, w_y)
vec_quadrat <- quadratcount(curr_ppp, tess=H)
vec_its <- intensity(vec_quadrat, image=TRUE)
par(mar=c(0.1,1, 1, 2))
plot(vec_its, main = "")
title(main = "hex binning", line = -2)
# Chunk 8: create rep1 all vectors
seed_number<- 589
w_x <-  c(min(floor(min(rep1_transcripts$x)),
floor(min(rep1_clusters$x))),
max(ceiling(max(rep1_transcripts$x)),
ceiling(max(rep1_clusters$x))))
w_y <-  c(min(floor(min(rep1_transcripts$y)),
floor(min(rep1_clusters$y))),
max(ceiling(max(rep1_transcripts$y)),
ceiling(max(rep1_clusters$y))))
grid_length <- 10
# get spatial vectors
rep1_sq10_vectors <- get_vectors(x= rep1_sub,
sample_names = "rep1",
cluster_info = rep1_clusters,
bin_type="square",
bin_param=c(grid_length,grid_length),
test_genes = all_real_genes ,
w_x=w_x, w_y=w_y)
seed_number<- 589
grid_length <- 10
cluster_w_x <- c(floor(min(rep1_clusters$x)), ceiling(max(rep1_clusters$x)))
cluster_w_y <- c(floor(min(rep1_clusters$y)), ceiling(max(rep1_clusters$y)))
# get spatial vectors for clusters
cluster_sq10_vectors <- get_vectors(x= NULL,
sample_names = "rep1",
cluster_info = rep1_clusters,
bin_type="square",
bin_param=c(grid_length,grid_length),
test_genes = all_real_genes ,
w_x=cluster_w_x, w_y=cluster_w_y)
# the gene vectors can be accessed as:
cluster_sq10_vectors$cluster_mt
#######################################################
transcript_w_x <-c(floor(min(rep1_transcripts$x)),
ceiling(max(rep1_transcripts$x)))
transcript_w_y <- c(floor(min(rep1_transcripts$y)),
ceiling(max(rep1_transcripts$y)))
# get spatial vectors for clusters
gene_sq10_vectors <- get_vectors(x= rep1_sub,
sample_names = "rep1",
cluster_info = NULL,
bin_type="square",
bin_param=c(grid_length,grid_length),
test_genes = all_real_genes ,
w_x=transcript_w_x, w_y=transcript_w_y)
# the gene vectors can be accessed as:
gene_sq10_vectors$gene_mt
table(gene_sq10_vectors$gene_mt[,1] = rep1_sq10_vectors$gene_mt[,1])
table(gene_sq10_vectors$gene_mt[,1] ==rep1_sq10_vectors$gene_mt[,1])
library(SpatialExperiment)
set.seed(100)
# simulate coordiantes for clusters
df_clA = data.frame(x = rnorm(n=5, mean=20, sd=5),
y = rnorm(n=5, mean=20, sd=5), cluster="A")
df_clB = data.frame(x = rnorm(n=5, mean=100, sd=5),
y = rnorm(n=5, mean=100, sd=5), cluster="B")
clusters = rbind(df_clA, df_clB)
clusters$sample="rep1"
# simulate coordiantes for genes
trans_info = data.frame(rbind(cbind(x = rnorm(n=5, mean=20, sd=5),
y = rnorm(n=5, mean=20, sd=5),
feature_name="gene_A1"),
cbind(x = rnorm(n=5, mean=20, sd=5),
y = rnorm(n=5, mean=20, sd=5),
feature_name="gene_A2"),
cbind(x = rnorm(n=5, mean=100, sd=5),
y = rnorm(n=5, mean=100, sd=5),
feature_name="gene_B1"),
cbind(x = rnorm(n=5, mean=100, sd=5),
y = rnorm(n=5, mean=100, sd=5),
feature_name="gene_B2")))
trans_info$x=as.numeric(trans_info$x)
trans_info$y=as.numeric(trans_info$y)
trans_info$cell =  rep(paste("cell",1:10, sep=""), times=2)
mol <- BumpyMatrix::splitAsBumpyMatrix(
trans_info[, c("x", "y")],
row = trans_info$feature_name, col = trans_info$cell )
spe_rep1 <- SpatialExperiment(
assays = list(molecules = mol),sample_id ="rep1" )
spe_rep2 <- SpatialExperiment(
assays = list(molecules = mol),sample_id ="rep2" )
invalid_spe_rep1 <-  SingleCellExperiment::cbind(spe_rep1,spe_rep2)
w_x =  c(min(floor(min(trans_info$x)),
floor(min(clusters$x))),
max(ceiling(max(trans_info$x)),
ceiling(max(clusters$x))))
w_y =  c(min(floor(min(trans_info$y)),
floor(min(clusters$y))),
max(ceiling(max(trans_info$y)),
ceiling(max(clusters$y))))
test_that("Invaid input",{
expect_error(compute_permp(x=trans_info,
cluster_info=clusters,
perm.size=10,
bin_type="square",
bin_param=c(2),
test_genes=unique(trans_info$feature_name),
correlation_method = "pearson",
n_cores=2,
correction_method="BH",
w_x=w_x ,
w_y=w_y))
expect_error(compute_permp(x=spe_rep1,
cluster_info=clusters,
perm.size=100,
bin_type="square",
bin_param=c(2),
test_genes=unique(trans_info$feature_name),
correlation_method = "pearson",
n_cores=2,
correction_method="BH",
w_x=w_x ,
w_y=w_y))
expect_error(compute_permp(x=spe_rep1,
cluster_info=clusters,
perm.size=100,
bin_type="hexagon",
bin_param=c(2,2),
test_genes=unique(trans_info$feature_name),
correlation_method = "pearson",
n_cores=2,
correction_method="BH",
w_x=w_x ,
w_y=w_y))
expect_error(compute_permp(x=spe_rep1,
cluster_info=clusters,
perm.size=100,
bin_type="circle",
bin_param=c(2,2),
test_genes=unique(trans_info$feature_name),
correlation_method = "pearson",
n_cores=2,
correction_method="BH",
w_x=w_x ,
w_y=w_y))
expect_error(compute_permp(x=invalid_spe_rep1,
cluster_info=clusters,
perm.size=100,
bin_type="circle",
bin_param=c(2,2),
test_genes=unique(trans_info$feature_name),
correlation_method = "pearson",
n_cores=2,
correction_method="BH",
w_x=w_x ,
w_y=w_y))
})
set.seed(100)
perm_p_lst_input = compute_permp(x=list("rep1"=trans_info),
cluster_info=clusters,
perm.size=10,
bin_type="square",
bin_param=c(2,2),
test_genes=unique(trans_info$feature_name),
correlation_method = "pearson",
n_cores=2,
correction_method="BH",
w_x=w_x ,
w_y=w_y)
expect_equal(as.vector(get_cor(perm_p_lst_input)),
c(1,1, -1/3, -1/3,-1/3,-1/3,1,1))
test_that("Test permutation  - can work for list input", {
expect_equal(as.vector(get_cor(perm_p_lst_input)),
c(1,1, -1/3, -1/3,-1/3,-1/3,1,1))
})
expect_equal(as.vector(get_cor(perm_p_lst_input)),
c(1,1, -1/3, -1/3,-1/3,-1/3,1,1))
test_that("Test permutation  - can work for list input", {
expect_equal(as.vector(get_cor(perm_p_lst_input)),
c(1,1, -1/3, -1/3,-1/3,-1/3,1,1))
expect_equal(dim(get_perm_p(perm_p_lst_input)), c(4,2))
expect_equal(dim(get_perm_adjp(perm_p_lst_input)), c(4,2))
expect_equal(dim(get_cor(perm_p_lst_input)), c(4,2))
})
devtools::document()
devtools::load_all()
packageDir <- "/vast/projects/xenium_5k/jazzPanda"
BiocCheck::BiocCheck(packageDir, 'new-package'=TRUE,"no-check-vignettes"=FALSE )
devtools::check(pkg = packageDir,  cran = TRUE, vignettes = TRUE)
BiocCheck::BiocCheckGitClone(package=packageDir)
# OR
BiocCheck::BiocCheck("/vast/scratch/users/jin.m/jazzPanda_0.99.0.tar.gz",
'new-package'=TRUE,"no-check-vignettes"=FALSE )
devtools::document()
devtools::load_all()
packageDir <- "/vast/projects/xenium_5k/jazzPanda"
BiocCheck::BiocCheck(packageDir, 'new-package'=FALSE,"no-check-vignettes"=FALSE )
devtools::check(pkg = packageDir,  cran = TRUE, vignettes = TRUE)
BiocCheck::BiocCheckGitClone(package=packageDir)
packageDir <- "/vast/projects/xenium_5k/jazzPanda"
BiocCheck::BiocCheck(packageDir, 'new-package'=FALSE,"no-check-vignettes"=FALSE )
devtools::check(pkg = packageDir,  cran = TRUE, vignettes = TRUE)
BiocCheck::BiocCheckGitClone(package=packageDir)
packageDir <- "/vast/projects/xenium_5k/jazzPanda"
BiocCheck::BiocCheck(packageDir, 'new-package'=FALSE,"no-check-vignettes"=FALSE )
devtools::check(pkg = packageDir,  cran = TRUE, vignettes = TRUE)
BiocCheck::BiocCheckGitClone(package=packageDir)
