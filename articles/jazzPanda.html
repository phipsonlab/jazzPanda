<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>jazzPanda example â€¢ jazzPanda</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="jazzPanda example">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">jazzPanda</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/jazzPanda.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/phipsonlab/jazzPanda/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>jazzPanda example</h1>
            
            <h4 data-toc-skip class="date">29 Nov 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/phipsonlab/jazzPanda/blob/main/vignettes/jazzPanda.Rmd" class="external-link"><code>vignettes/jazzPanda.Rmd</code></a></small>
      <div class="d-none name"><code>jazzPanda.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Spatial transcriptomics allows the spatial profiling of complex
tissue architectures. The spatial arrangement and interactions between
cells can aid in understanding of complex functions and regulatory
mechanisms in various tissue micro environments. Commercially available
image-based spatial technologies such as Xenium, CosMX, and MERSCOPSE
take advantage of fluorescence-based microscopy to quantify transcripts
and focus on a pre-designed panel of genes. </p>
<p>One crucial step in the analysis of spatial transcriptomics data is
cell type annotation. There are a number of ways to perform cell type
annotation, and marker analysis is one of them. Marker gene analysis to
identify genes highly expressed in each cluster compared to the
remaining clusters. The identified marker genes are used to annotate
clusters with cell types. Computationally tools originally developed for
single cell data are used for spatial transcriptomics studies. However,
those methods ignore the spatial information for the cells and gene.
There is limited literature on developing marker gene detection methods
that account for the spatial distribution of gene expression. jazzPanda
provides two novel approaches to detect marker genes with transformed
spatial information. Our first approach is based on correlation and the
second linear modelling approach can account for technical noise and
work for studies with multiple samples. </p>
</div>
<div class="section level2">
<h2 id="jazzpanda-framework">jazzPanda framework<a class="anchor" aria-label="anchor" href="#jazzpanda-framework"></a>
</h2>
<p>We assume a marker gene will show a significant linear relationship
with the target cluster over the tissue space. This suggests that the
transcript detection of a marker gene will show similar patterns with
the cells from the cluster over tissue space. Given the cluster label of
every cell, there are two steps to obtain marker genes for every
cluster. We first compute spatial vectors from the spatial coordinates
of the genes and the clusters. After that, we can measure the linear
relationship between the genes and clusters based on spatial vectors. We
develop two approaches for detecting genes that show strong linear
relationship with the cluster.</p>
<ul>
<li><p><strong>Step 1:</strong> <em>Create spatial vectors for every
gene and every cluster</em><br><code><a href="../reference/get_vectors.html">get_vectors()</a></code> can be used to convert the transcript
detection and the cell centroids to spatial vectors. You can specify the
tile shape and length based on you dataset. The hex bins will generally
take longer than the square/rectangle bins to compute. In practice, we
find that we can choose the length tiles such that the average cell per
tile
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mrow><mtext mathvariant="monospace">#</mtext><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> cells per cluster</mtext></mrow></mrow><mrow><mtext mathvariant="monospace">#</mtext><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> tiles</mtext></mrow></mrow></mfrac><annotation encoding="application/x-tex">\frac{\texttt{\#}\text{ cells per cluster} }{\texttt{\#}\text{ tiles}}</annotation></semantics></math>)
is close to one for each cluster. </p></li>
<li>
<p><strong>Step 2:</strong> <em>Detect marker genes</em></p>
<ul>
<li><p>Correlation approach: <code><a href="../reference/compute_permp.html">compute_permp()</a></code> This approach
can detect marker genes for one sample study. We calculate a correlation
coefficient between every pair of gene and cluster vector. We perform
permutation testing to assess the statistical significance of the
calculated correlation and followed by multiple testing adjustment to
control the false discovery rate. We keep the genes with significant
adjusted p-value and large correlation as marker genes. In practice, we
recommend to calculate a correlation threshold value for every cluster
based on the data distribution. During our analysis, we use 75% quantile
value of all correlations to the given cluster as the cutoff and manage
to keep meaningful marker genes.</p></li>
<li>
<p>Linear modelling approach: <code><a href="../reference/lasso_markers.html">lasso_markers()</a></code> In this
approach, we treat the gene vector as the response variable and the
cluster vectors as the explanatory variables. We select the important
cluster vectors by lasso regularization first, and fit a linear model to
find the cluster that show minimum p-value and largest model
coefficient. This approach can account for multi-sample studies and the
technical background noise (such as the non-specific binding). We
recommend to set a model coefficient cutoff value based on your data. A
large cutoff value will result in fewer marker genes whereas a small
cutoff value will detect more marker genes. We find a cutoff value at
0.1 or 0.2 work well for our analysis. Marker genes with less than 0.1
model coefficient are generally weak markers.<br>
Two tables will be returned from this approach:</p>
<ol style="list-style-type: decimal">
<li><p>We record the most significant cluster for each gene as
<code>lasso_top_result</code>. This table provides unique marker genes
for every cluster. Genes whose top cluster shows a model coefficient
smaller than the specified cutoff value will not be labeled as marker
genes.</p></li>
<li><p>We record all the significant cluster for each gene as
<code>lasso_full_result</code>. This table can be used to investigate
shared marker genes for different clusters.</p></li>
</ol>
</li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>The dataset used in this vignette is a selected subset from two
replicates of Xenium human breast cancer tissue Sample 1. We select 20
genes for package illustration. This subset was extracted from the raw
dataset as described in the R script located at
<code>/inst/generate_vignette_data.R</code>. </p>
<p>This subset data is used for package illustration purpose only. The
resulting marker genes may not be strong markers for annotating
clusters. Please see the full analysis for this dataset for marker
genes.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/drighelli/SpatialExperiment" class="external-link">SpatialExperiment</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/phipsonlab/jazzPanda" class="external-link">jazzPanda</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glmnet.stanford.edu" class="external-link">glmnet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/" class="external-link">caret</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/taiyun/corrplot" class="external-link">corrplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r.igraph.org/" class="external-link">igraph</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggraph.data-imaginist.com" class="external-link">ggraph</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggrepel.slowkow.com/" class="external-link">ggrepel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">utils</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://spatstat.org/" class="external-link">spatstat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/" class="external-link">ggpubr</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ggplot style</span></span>
<span><span class="va">defined_theme</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">rel</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                                                    colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>                        axis.line<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        axis.ticks<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        legend.position<span class="op">=</span><span class="st">"none"</span>,</span>
<span>                        panel.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        panel.border<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        panel.grid.major<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        panel.grid.minor<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        plot.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="load-data">Load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">rep1_sub</span>, <span class="va">rep1_clusters</span>, <span class="va">rep1_neg</span><span class="op">)</span></span>
<span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">cluster</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">cluster</span>,</span>
<span>                            levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"c"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># record the transcript coordinates for rep1</span></span>
<span><span class="va">rep1_transcripts</span> <span class="op">&lt;-</span><span class="fu">BumpyMatrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BumpyMatrix/man/unsplitAsDataFrame.html" class="external-link">unsplitAsDataFrame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-assays.html" class="external-link">molecules</a></span><span class="op">(</span><span class="va">rep1_sub</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rep1_transcripts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"feature_name"</span>,<span class="st">"cell_id"</span>,<span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span></span>
<span><span class="co"># record the negative control transcript coordinates for rep1</span></span>
<span><span class="va">rep1_nc_data</span> <span class="op">&lt;-</span> <span class="fu">BumpyMatrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BumpyMatrix/man/unsplitAsDataFrame.html" class="external-link">unsplitAsDataFrame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-assays.html" class="external-link">molecules</a></span><span class="op">(</span><span class="va">rep1_neg</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rep1_nc_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">rep1_nc_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rep1_nc_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"feature_name"</span>,<span class="st">"cell_id"</span>,<span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"category"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># record all real genes in the data</span></span>
<span><span class="va">all_real_genes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">feature_name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">all_celltypes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"anno"</span>,<span class="st">"cluster"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># nc_patterns = "^BLANK_|^NegControlProbe_|^NegControlCodeword_|^antisense_"</span></span>
<span><span class="co"># nc_targets = grep(pattern =nc_patterns , x = test_genes,value = TRUE)</span></span></code></pre></div>
<p>The main function <code><a href="../reference/lasso_markers.html">lasso_markers()</a></code> requires spatial
vectors for each cluster and gene. These vectors can be conveniently
generated using the <code><a href="../reference/get_vectors.html">get_vectors()</a></code> function. Currently, the
get_vectors() function supports inputs of type
<code>SingleCellExperiment</code>, <code>SpatialExperiment</code>, or
<code>SpatialFeatureExperiment</code></p>
<div class="section level4">
<h4 id="from-a-spatialexperiment-object">From a SpatialExperiment object<a class="anchor" aria-label="anchor" href="#from-a-spatialexperiment-object"></a>
</h4>
<p>If the transcript coordinates are available, you can use either
transcript coordinates or the count matrix to define spatial vectors for
genes. The defined example_vectors_cm/example_vectors_tr can be passed
to <code>lasso_markers</code> to identify marker genes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pachterlab/SpatialFeatureExperiment" class="external-link">SpatialFeatureExperiment</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrbakhsh/TENxXeniumData" class="external-link">TENxXeniumData</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ExperimentHub</span><span class="op">)</span></span>
<span><span class="va">eh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ExperimentHub/man/ExperimentHub-class.html" class="external-link">ExperimentHub</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AnnotationHub/man/AnnotationHub-class.html" class="external-link">query</a></span><span class="op">(</span><span class="va">eh</span>, <span class="st">"TENxXenium"</span><span class="op">)</span></span>
<span><span class="va">spe_example</span> <span class="op">&lt;-</span> <span class="va">q</span><span class="op">[[</span><span class="st">"EH8547"</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="co"># -----------------------------------------------------------------------------</span></span>
<span><span class="co"># Example clustering </span></span>
<span><span class="co"># get the count matrix </span></span>
<span><span class="va">cm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">counts</a></span><span class="op">(</span><span class="va">spe_example</span><span class="op">)</span></span>
<span><span class="va">test_genes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">cm</span><span class="op">)</span></span>
<span><span class="va">example_seu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">cm</span>, </span>
<span>                            min.cells <span class="op">=</span> <span class="fl">2</span>, min.features <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">example_seu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">example_seu</span>, </span>
<span>                            normalization.method <span class="op">=</span> <span class="st">"LogNormalize"</span><span class="op">)</span></span>
<span><span class="va">all.genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">example_seu</span><span class="op">)</span></span>
<span><span class="va">example_seu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="va">example_seu</span>, features <span class="op">=</span> <span class="va">all.genes</span><span class="op">)</span></span>
<span><span class="va">example_seu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span><span class="va">example_seu</span>, features <span class="op">=</span> <span class="va">all.genes</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/ElbowPlot.html" class="external-link">ElbowPlot</a></span><span class="op">(</span><span class="va">example_seu</span><span class="op">)</span></span>
<span><span class="va">example_seu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span><span class="va">example_seu</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">example_seu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="va">example_seu</span>, resolution <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">seu_clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">example_seu</span><span class="op">$</span><span class="va">seurat_clusters</span>,nm<span class="op">=</span><span class="st">"cluster"</span><span class="op">)</span></span>
<span><span class="va">seu_clusters</span><span class="op">$</span><span class="va">cell_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">example_seu</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -----------------------------------------------------------------------------</span></span>
<span><span class="co"># combine cluster labels and the coordinates </span></span>
<span><span class="co"># make sure the cluster information contains column names: </span></span>
<span><span class="co"># cluster, x, y, sample and cell_id</span></span>
<span><span class="va">clusters_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">spe_example</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">clusters_info</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span></span>
<span><span class="va">clusters_info</span><span class="op">$</span><span class="va">cell_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">clusters_info</span><span class="op">)</span></span>
<span><span class="va">clusters_info</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="va">spe_example</span><span class="op">$</span><span class="va">sample_id</span></span>
<span><span class="va">clusters_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">clusters_info</span>, <span class="va">seu_clusters</span>, by<span class="op">=</span><span class="st">"cell_id"</span><span class="op">)</span></span>
<span><span class="va">clusters_info</span><span class="op">$</span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"c"</span>,<span class="va">clusters_info</span><span class="op">$</span><span class="va">cluster</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">w_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="va">w_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -----------------------------------------------------------------------------</span></span>
<span><span class="co"># build spatial vectors from count matrix and cluster coordinates </span></span>
<span><span class="va">example_vectors_cm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_vectors.html">get_vectors</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">spe_example</span>,</span>
<span>                                sample_names <span class="op">=</span> <span class="st">"sample01"</span>,</span>
<span>                                cluster_info <span class="op">=</span> <span class="va">clusters_info</span>,</span>
<span>                                bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, </span>
<span>                                test_genes <span class="op">=</span> <span class="va">test_genes</span>,</span>
<span>                                use_cm<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                                w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span><span class="op">)</span></span>
<span><span class="co"># spatial vector for every cluster </span></span>
<span><span class="va">example_vectors_cm</span><span class="op">$</span><span class="va">cluster_mt</span></span>
<span></span>
<span><span class="co"># spatial vector for every gene </span></span>
<span><span class="va">example_vectors_cm</span><span class="op">$</span><span class="va">gene_mt</span></span>
<span><span class="co"># -----------------------------------------------------------------------------</span></span>
<span><span class="co"># build spatial vectors from transcript coordinates and cluster coordinates </span></span>
<span><span class="va">example_vectors_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_vectors.html">get_vectors</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">spe_example</span>,</span>
<span>                                sample_names <span class="op">=</span> <span class="st">"sample01"</span>,</span>
<span>                                cluster_info <span class="op">=</span> <span class="va">clusters_info</span>,</span>
<span>                                bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, </span>
<span>                                test_genes <span class="op">=</span> <span class="va">test_genes</span>,</span>
<span>                                use_cm<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                                w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span><span class="op">)</span></span>
<span><span class="co"># spatial vector for every cluster </span></span>
<span><span class="va">example_vectors_tr</span><span class="op">$</span><span class="va">cluster_mt</span></span>
<span></span>
<span><span class="co"># spatial vector for every gene </span></span>
<span><span class="va">example_vectors_tr</span><span class="op">$</span><span class="va">gene_mt</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="from-a-spatialfeatureexperiment-object">From a SpatialFeatureExperiment object<a class="anchor" aria-label="anchor" href="#from-a-spatialfeatureexperiment-object"></a>
</h4>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sfe_example</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/SpatialFeatureExperiment-coercion.html" class="external-link">toSpatialFeatureExperiment</a></span><span class="op">(</span><span class="va">spe_example</span><span class="op">)</span></span>
<span><span class="co"># -----------------------------------------------------------------------------</span></span>
<span><span class="co"># build spatial vectors from count matrix and cluster coordinates </span></span>
<span><span class="co"># make sure the cluster information contains column names: </span></span>
<span><span class="co"># cluster, x, y, sample and cell_id</span></span>
<span><span class="va">example_vectors_cm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_vectors.html">get_vectors</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">sfe_example</span>,</span>
<span>                                sample_names <span class="op">=</span> <span class="st">"sample01"</span>,</span>
<span>                                cluster_info <span class="op">=</span> <span class="va">clusters_info</span>,</span>
<span>                                bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, </span>
<span>                                test_genes <span class="op">=</span> <span class="va">test_genes</span>,</span>
<span>                                w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span>, </span>
<span>                                use_cm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># spatial vector for every cluster </span></span>
<span><span class="va">example_vectors_cm</span><span class="op">$</span><span class="va">cluster_mt</span></span>
<span></span>
<span><span class="co"># spatial vector for every gene </span></span>
<span><span class="va">example_vectors_cm</span><span class="op">$</span><span class="va">gene_mt</span></span>
<span><span class="co"># -----------------------------------------------------------------------------</span></span>
<span><span class="co"># build spatial vectors from transcript coordinates and cluster coordinates </span></span>
<span><span class="va">example_vectors_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_vectors.html">get_vectors</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">sfe_example</span>,</span>
<span>                                sample_names <span class="op">=</span> <span class="st">"sample01"</span>,</span>
<span>                                cluster_info <span class="op">=</span> <span class="va">clusters_info</span>,</span>
<span>                                bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, </span>
<span>                                test_genes <span class="op">=</span> <span class="va">test_genes</span>,</span>
<span>                                w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span>, </span>
<span>                                use_cm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># spatial vector for every cluster </span></span>
<span><span class="va">example_vectors_tr</span><span class="op">$</span><span class="va">cluster_mt</span></span>
<span></span>
<span><span class="co"># spatial vector for every gene </span></span>
<span><span class="va">example_vectors_tr</span><span class="op">$</span><span class="va">gene_mt</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="from-a-singlecellexperiment-object">From a SingleCellExperiment object<a class="anchor" aria-label="anchor" href="#from-a-singlecellexperiment-object"></a>
</h4>
<p>If the input is a SingleCellExperiment object, the spatial vectors
for the genes can only be computed using the count matrix and the cell
coordinates The defined example_vectors_cm can be passed to
<code>lasso_markers</code> to identify marker genes. \ If transcript
coordinate information is available, you can alternatively create a
SpatialExperiment object and compute the spatial vectors using the
transcript coordinates.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sce_example</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/SingleCellExperiment.html" class="external-link">SingleCellExperiment</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sample01 <span class="op">=</span> <span class="va">cm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># -----------------------------------------------------------------------------</span></span>
<span><span class="co"># build spatial vectors from count matrix and cluster coordinates </span></span>
<span><span class="co"># make sure the cluster information contains column names: </span></span>
<span><span class="co"># cluster, x, y, sample and cell_id</span></span>
<span><span class="va">example_vectors_cm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_vectors.html">get_vectors</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">sce_example</span>,</span>
<span>                                sample_names <span class="op">=</span> <span class="st">"sample01"</span>,</span>
<span>                                cluster_info <span class="op">=</span> <span class="va">clusters_info</span>,</span>
<span>                                bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, </span>
<span>                                test_genes <span class="op">=</span> <span class="va">test_genes</span>,</span>
<span>                                w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span>, </span>
<span>                                use_cm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># spatial vector for every cluster </span></span>
<span><span class="va">example_vectors_cm</span><span class="op">$</span><span class="va">cluster_mt</span></span>
<span></span>
<span><span class="co"># spatial vector for every gene </span></span>
<span><span class="va">example_vectors_cm</span><span class="op">$</span><span class="va">gene_mt</span></span>
<span></span>
<span><span class="co"># -----------------------------------------------------------------------------</span></span>
<span><span class="co"># If the transcript coordinate information is available</span></span>
<span><span class="co"># make sure the transcript information contains column names: </span></span>
<span><span class="co"># feature_name, x, y</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment.html" class="external-link">SpatialExperiment</a></span><span class="op">(</span></span>
<span>    assays <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        molecules <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-assays.html" class="external-link">molecules</a></span><span class="op">(</span><span class="va">sfe_example</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    sample_id <span class="op">=</span><span class="st">"sample01"</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># build spatial vectors from transcript coordinates and cluster coordinates </span></span>
<span><span class="va">example_vectors_tr</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_vectors.html">get_vectors</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">spe</span>, sample_names <span class="op">=</span> <span class="st">"sample01"</span>,</span>
<span>                                cluster_info <span class="op">=</span> <span class="va">clusters_info</span>,</span>
<span>                                bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, </span>
<span>                                test_genes <span class="op">=</span> <span class="va">test_genes</span>,</span>
<span>                                w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span><span class="op">)</span></span>
<span><span class="co"># spatial vector for every cluster </span></span>
<span><span class="va">example_vectors_tr</span><span class="op">$</span><span class="va">cluster_mt</span></span>
<span></span>
<span><span class="co"># spatial vector for every gene </span></span>
<span><span class="va">example_vectors_tr</span><span class="op">$</span><span class="va">gene_mt</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="from-a-seurat-object">From a Seurat object<a class="anchor" aria-label="anchor" href="#from-a-seurat-object"></a>
</h4>
<p>If you have a Seurat object, the spatial vectors for the genes can
only be computed using the count matrix and the cell coordinates The
defined example_vectors_cm can be passed to <code>lasso_markers</code>
to identify marker genes. \ If transcript coordinate information is
available, you can alternatively create a SpatialExperiment object and
compute the spatial vectors using the transcript coordinates.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># cm is the count matrix</span></span>
<span><span class="va">seu_obj</span> <span class="op">&lt;-</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">cm</span><span class="op">)</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/SingleCellExperiment.html" class="external-link">SingleCellExperiment</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sample01 <span class="op">=</span><span class="va">seu_obj</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">$</span><span class="va">counts</span> <span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># we will use the previously defined cluster_info for illustration here</span></span>
<span><span class="co"># make sure the clusters information contains column names: </span></span>
<span><span class="co"># cluster, x, y and sample</span></span>
<span><span class="va">clusters_info</span> <span class="op">=</span> <span class="va">clusters_info</span></span>
<span></span>
<span><span class="va">w_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="va">w_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -----------------------------------------------------------------------------</span></span>
<span><span class="co"># build spatial vectors from count matrix and cluster coordinates </span></span>
<span><span class="co"># make sure the cluster information contains column names: </span></span>
<span><span class="co"># cluster, x, y, sample and cell_id</span></span>
<span><span class="va">example_vectors_cm</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_vectors.html">get_vectors</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">sce</span>, sample_names <span class="op">=</span> <span class="st">"sample01"</span>,</span>
<span>                                cluster_info <span class="op">=</span> <span class="va">clusters_info</span>,</span>
<span>                                bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, </span>
<span>                                test_genes <span class="op">=</span> <span class="va">test_genes</span>,</span>
<span>                                w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span>,</span>
<span>                                use_cm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># spatial vector for every cluster </span></span>
<span><span class="va">example_vectors_cm</span><span class="op">$</span><span class="va">cluster_mt</span></span>
<span></span>
<span><span class="co"># spatial vector for every gene </span></span>
<span><span class="va">example_vectors_cm</span><span class="op">$</span><span class="va">gene_mt</span></span>
<span></span>
<span><span class="co"># -----------------------------------------------------------------------------</span></span>
<span><span class="co"># If the transcript coordinate information is available</span></span>
<span><span class="co"># make sure the transcript information contains column names: </span></span>
<span><span class="co"># feature_name, x, y</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment.html" class="external-link">SpatialExperiment</a></span><span class="op">(</span></span>
<span>    assays <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        molecules <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-assays.html" class="external-link">molecules</a></span><span class="op">(</span><span class="va">sfe_example</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    sample_id <span class="op">=</span><span class="st">"sample01"</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># build spatial vectors from transcript coordinates and cluster coordinates </span></span>
<span><span class="va">example_vectors_tr</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_vectors.html">get_vectors</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">spe</span>, sample_names <span class="op">=</span> <span class="st">"sample01"</span>,</span>
<span>                                cluster_info <span class="op">=</span> <span class="va">clusters_info</span>,</span>
<span>                                bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, </span>
<span>                                test_genes <span class="op">=</span> <span class="va">test_genes</span>,</span>
<span>                                w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span><span class="op">)</span></span>
<span><span class="co"># spatial vector for every cluster </span></span>
<span><span class="va">example_vectors_tr</span><span class="op">$</span><span class="va">cluster_mt</span></span>
<span></span>
<span><span class="co"># spatial vector for every gene </span></span>
<span><span class="va">example_vectors_tr</span><span class="op">$</span><span class="va">gene_mt</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="visualise-the-clusters-over-the-tissue-space">Visualise the clusters over the tissue space<a class="anchor" aria-label="anchor" href="#visualise-the-clusters-over-the-tissue-space"></a>
</h3>
<p>We can plot the cells coordinates for each cluster of Replicate 1
subset</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">rep1_clusters</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitterdodge.html" class="external-link">position_jitterdodge</a></span><span class="op">(</span>jitter.width<span class="op">=</span><span class="fl">0</span>,</span>
<span>                                        jitter.height<span class="op">=</span><span class="fl">0</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">sample</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#FC8D62"</span>,<span class="st">"#66C2A5"</span> ,<span class="st">"#8DA0CB"</span>,<span class="st">"#E78AC3"</span>,</span>
<span>                        <span class="st">"#A6D854"</span>,<span class="st">"skyblue"</span>,<span class="st">"purple3"</span>,<span class="st">"#E5C498"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"cluster"</span>, nrow <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                        override.aes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                axis.ticks<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                panel.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>                legend.position<span class="op">=</span><span class="st">"none"</span>,</span>
<span>                strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">rel</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">p2</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">rep1_clusters</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitterdodge.html" class="external-link">position_jitterdodge</a></span><span class="op">(</span>jitter.width<span class="op">=</span><span class="fl">0</span>, </span>
<span>                                    jitter.height<span class="op">=</span><span class="fl">0</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">cluster</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#FC8D62"</span>,<span class="st">"#66C2A5"</span> ,<span class="st">"#8DA0CB"</span>,<span class="st">"#E78AC3"</span>,</span>
<span>                        <span class="st">"#A6D854"</span>,<span class="st">"skyblue"</span>,<span class="st">"purple3"</span>,<span class="st">"#E5C498"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"cluster"</span>, nrow <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        override.aes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            axis.ticks<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            panel.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"lines"</span><span class="op">)</span>, </span>
<span>            legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>            legend.position<span class="op">=</span><span class="st">"none"</span>,</span>
<span>            legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>            strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">rel</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="va">spacer</span> <span class="op">&lt;-</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_spacer.html" class="external-link">plot_spacer</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">layout_design</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">p1</span> <span class="op">/</span> <span class="va">spacer</span><span class="op">)</span> <span class="op">|</span> <span class="va">p2</span></span>
<span></span>
<span><span class="va">layout_design</span> <span class="op">&lt;-</span> <span class="va">layout_design</span> <span class="op">+</span> </span>
<span>                    <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>, heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">layout_design</span><span class="op">)</span></span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/rep%20clusters%20vis-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="spatial-vectors">Spatial vectors<a class="anchor" aria-label="anchor" href="#spatial-vectors"></a>
</h3>
<p>We can visualize the spatial vectors for clusters and genes as
follows. As an example for creating spatial vectors for genes, we plot
the transcript detections for the gene EPCAM over tissue space, along
with the square and hex binning result. Similarly, we plot the cell
coordinates in cluster c1, as well as the square and hex bin values over
the space as an example. We can see that with the square and hex bins
capture the key patterns of the original coordinates. Hex bins can
capture more details than square bins.</p>
<div class="section level4">
<h4 id="example-of-gene-vectors">Example of gene vectors<a class="anchor" aria-label="anchor" href="#example-of-gene-vectors"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w_x</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w_y</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot transcript detection coordinates</span></span>
<span><span class="va">selected_genes</span> <span class="op">=</span> <span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">feature_name</span> <span class="op">==</span> <span class="st">"EPCAM"</span></span>
<span><span class="va">loc_mt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">[</span><span class="va">selected_genes</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"feature_name"</span><span class="op">)</span><span class="op">]</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">loc_mt</span><span class="op">)</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"feature_name"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">3</span>,<span class="fl">6</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">loc_mt</span><span class="op">$</span><span class="va">x</span>, <span class="va">loc_mt</span><span class="op">$</span><span class="va">y</span>, main <span class="op">=</span> <span class="st">""</span>, xlab <span class="op">=</span> <span class="st">""</span>, ylab <span class="op">=</span> <span class="st">""</span>, </span>
<span>        pch <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="st">"maroon4"</span>, cex <span class="op">=</span> <span class="fl">0.1</span>,xaxt<span class="op">=</span><span class="st">'n'</span>, yaxt<span class="op">=</span><span class="st">'n'</span><span class="op">)</span>   </span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"EPCAM transcript detection"</span>, line <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html" class="external-link">box</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># plot square binning </span></span>
<span><span class="va">curr</span><span class="op">&lt;-</span><span class="va">loc_mt</span><span class="op">[</span><span class="va">loc_mt</span><span class="op">[</span>,<span class="st">"feature_name"</span><span class="op">]</span><span class="op">==</span><span class="st">"EPCAM"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">curr_ppp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/ppp.html" class="external-link">ppp</a></span><span class="op">(</span><span class="va">curr</span><span class="op">$</span><span class="va">x</span>,<span class="va">curr</span><span class="op">$</span><span class="va">y</span>,<span class="va">w_x</span>, <span class="va">w_y</span><span class="op">)</span></span>
<span><span class="va">vec_quadrat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/quadratcount.html" class="external-link">quadratcount</a></span><span class="op">(</span><span class="va">curr_ppp</span>, <span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">vec_its</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/intensity.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">vec_quadrat</span>, image<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vec_its</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"square binning"</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot hex binning </span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/owin.html" class="external-link">owin</a></span><span class="op">(</span>xrange<span class="op">=</span><span class="va">w_x</span>, yrange<span class="op">=</span><span class="va">w_y</span><span class="op">)</span></span>
<span><span class="va">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/hextess.html" class="external-link">hextess</a></span><span class="op">(</span>W<span class="op">=</span><span class="va">w</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">bin_length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">H</span><span class="op">$</span><span class="va">tiles</span><span class="op">)</span></span>
<span><span class="va">curr</span><span class="op">&lt;-</span><span class="va">loc_mt</span><span class="op">[</span><span class="va">loc_mt</span><span class="op">[</span>,<span class="st">"feature_name"</span><span class="op">]</span><span class="op">==</span><span class="st">"EPCAM"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">curr_ppp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/ppp.html" class="external-link">ppp</a></span><span class="op">(</span><span class="va">curr</span><span class="op">$</span><span class="va">x</span>,<span class="va">curr</span><span class="op">$</span><span class="va">y</span>,<span class="va">w_x</span>, <span class="va">w_y</span><span class="op">)</span></span>
<span><span class="va">vec_quadrat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/quadratcount.html" class="external-link">quadratcount</a></span><span class="op">(</span><span class="va">curr_ppp</span>, tess<span class="op">=</span><span class="va">H</span><span class="op">)</span></span>
<span><span class="va">vec_its</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/intensity.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">vec_quadrat</span>, image<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vec_its</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"hex binning"</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/plot%20spatial%20genes-1.png" width="576"></p>
</div>
<div class="section level4">
<h4 id="example-of-cluster-vectors">Example of cluster vectors<a class="anchor" aria-label="anchor" href="#example-of-cluster-vectors"></a>
</h4>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w_x</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w_y</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot cell coordinates</span></span>
<span><span class="va">loc_mt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">[</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">cluster</span><span class="op">==</span><span class="st">"c1"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"cluster"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">loc_mt</span><span class="op">)</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"cluster"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">3</span>,<span class="fl">6</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">loc_mt</span><span class="op">$</span><span class="va">x</span>, <span class="va">loc_mt</span><span class="op">$</span><span class="va">y</span>, main <span class="op">=</span> <span class="st">""</span>, xlab <span class="op">=</span> <span class="st">""</span>, ylab <span class="op">=</span> <span class="st">""</span>, </span>
<span>        pch <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="st">"maroon4"</span>, cex <span class="op">=</span> <span class="fl">0.1</span>,xaxt<span class="op">=</span><span class="st">'n'</span>, yaxt<span class="op">=</span><span class="st">'n'</span><span class="op">)</span>   </span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"cell coordinates in cluster c1"</span>, line <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html" class="external-link">box</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># plot square binning </span></span>
<span><span class="va">curr</span><span class="op">&lt;-</span><span class="va">loc_mt</span><span class="op">[</span><span class="va">loc_mt</span><span class="op">[</span>,<span class="st">"cluster"</span><span class="op">]</span><span class="op">==</span><span class="st">"c1"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">curr_ppp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/ppp.html" class="external-link">ppp</a></span><span class="op">(</span><span class="va">curr</span><span class="op">$</span><span class="va">x</span>,<span class="va">curr</span><span class="op">$</span><span class="va">y</span>,<span class="va">w_x</span>, <span class="va">w_y</span><span class="op">)</span></span>
<span><span class="va">vec_quadrat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/quadratcount.html" class="external-link">quadratcount</a></span><span class="op">(</span><span class="va">curr_ppp</span>, <span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">vec_its</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/intensity.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">vec_quadrat</span>, image<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vec_its</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"square binning"</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot hex binning </span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/owin.html" class="external-link">owin</a></span><span class="op">(</span>xrange<span class="op">=</span><span class="va">w_x</span>, yrange<span class="op">=</span><span class="va">w_y</span><span class="op">)</span></span>
<span><span class="va">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/hextess.html" class="external-link">hextess</a></span><span class="op">(</span>W<span class="op">=</span><span class="va">w</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">bin_length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">H</span><span class="op">$</span><span class="va">tiles</span><span class="op">)</span></span>
<span><span class="va">curr</span><span class="op">&lt;-</span><span class="va">loc_mt</span><span class="op">[</span><span class="va">loc_mt</span><span class="op">[</span>,<span class="st">"cluster"</span><span class="op">]</span><span class="op">==</span><span class="st">"c1"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">curr_ppp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/ppp.html" class="external-link">ppp</a></span><span class="op">(</span><span class="va">curr</span><span class="op">$</span><span class="va">x</span>,<span class="va">curr</span><span class="op">$</span><span class="va">y</span>,<span class="va">w_x</span>, <span class="va">w_y</span><span class="op">)</span></span>
<span><span class="va">vec_quadrat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/quadratcount.html" class="external-link">quadratcount</a></span><span class="op">(</span><span class="va">curr_ppp</span>, tess<span class="op">=</span><span class="va">H</span><span class="op">)</span></span>
<span><span class="va">vec_its</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/intensity.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">vec_quadrat</span>, image<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vec_its</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"hex binning"</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/plot%20spatial%20clusters-1.png" width="576"></p>
<p>The function <code><a href="../reference/get_vectors.html">get_vectors()</a></code> can be used to create spatial
vectors for all the genes and clusters. These spatial vectors may take
the form of squares, rectangles, or hexagons specified by the
<code>bin_type</code> parameter.</p>
</div>
<div class="section level4">
<h4 id="spatial-vectors-for-all-genes-and-clusters">Spatial vectors for all genes and clusters<a class="anchor" aria-label="anchor" href="#spatial-vectors-for-all-genes-and-clusters"></a>
</h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seed_number</span><span class="op">=</span> <span class="fl">589</span></span>
<span></span>
<span><span class="va">w_x</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w_y</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">grid_length</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="co"># get spatial vectors</span></span>
<span><span class="va">rep1_sq10_vectors</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_vectors.html">get_vectors</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">rep1_sub</span>,</span>
<span>                                sample_names <span class="op">=</span> <span class="st">"rep1"</span>,</span>
<span>                                cluster_info <span class="op">=</span> <span class="va">rep1_clusters</span>,</span>
<span>                                bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">grid_length</span>,<span class="va">grid_length</span><span class="op">)</span>, </span>
<span>                                test_genes <span class="op">=</span> <span class="va">all_real_genes</span> , </span>
<span>                                w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span><span class="op">)</span></span></code></pre></div>
<p>The constructed spatial vectors can be used to quantify
cluster-cluster and gene-gene correlation.</p>
<div class="section level5">
<h5 id="cluster-cluster-correlation">Cluster-Cluster correlation<a class="anchor" aria-label="anchor" href="#cluster-cluster-correlation"></a>
</h5>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exp_ord</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">cluster_mt</span> <span class="op">=</span> <span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">cluster_mt</span><span class="op">[</span>,<span class="va">exp_ord</span><span class="op">]</span></span>
<span><span class="va">cor_cluster_mt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">cluster_mt</span>,</span>
<span>                <span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">cluster_mt</span>, method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span>
<span><span class="co"># Calculate pairwise correlations</span></span>
<span><span class="va">cor_gene_mt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">gene_mt</span>, <span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">gene_mt</span>,</span>
<span>                    method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">col</span> <span class="op">&lt;-</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#4477AA"</span>, <span class="st">"#77AADD"</span>, </span>
<span>                                    <span class="st">"#FFFFFF"</span>,<span class="st">"#EE9988"</span>, <span class="st">"#BB4444"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">corrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.html" class="external-link">corrplot</a></span><span class="op">(</span><span class="va">cor_cluster_mt</span>, method<span class="op">=</span><span class="st">"color"</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/col.html" class="external-link">col</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span>, diag<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                addCoef.col <span class="op">=</span> <span class="st">"black"</span>,type<span class="op">=</span><span class="st">"upper"</span>,</span>
<span>                tl.col<span class="op">=</span><span class="st">"black"</span>, tl.srt<span class="op">=</span><span class="fl">45</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">5</span>,<span class="fl">0</span><span class="op">)</span>,sig.level <span class="op">=</span> <span class="fl">0.05</span>, </span>
<span>                insig <span class="op">=</span> <span class="st">"blank"</span>, </span>
<span>                title <span class="op">=</span> <span class="st">"cluster-cluster correlation (square bin = 40x40)"</span></span>
<span>                <span class="op">)</span></span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
</div>
<div class="section level5">
<h5 id="gene-cluster-correlation">Gene-Cluster correlation<a class="anchor" aria-label="anchor" href="#gene-cluster-correlation"></a>
</h5>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cor_genecluster_mt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">gene_mt</span>, </span>
<span>                        y<span class="op">=</span><span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">cluster_mt</span>, method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gg_correlation</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">cor_gene_mt</span>, MARGIN<span class="op">=</span><span class="fl">1</span>, </span>
<span>                                            FUN <span class="op">=</span> <span class="va">mean</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                                        <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">cor_genecluster_mt</span>, MARGIN<span class="op">=</span><span class="fl">1</span>, </span>
<span>                                            FUN <span class="op">=</span> <span class="va">mean</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">gg_correlation</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mean_correlation"</span>,<span class="st">"mean_cluster"</span><span class="op">)</span>  </span>
<span><span class="va">gg_correlation</span><span class="op">$</span><span class="va">gene</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">gg_correlation</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">gg_correlation</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">mean_correlation</span>, y<span class="op">=</span><span class="va">mean_cluster</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label<span class="op">=</span><span class="va">gg_correlation</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">1.8</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>            axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>            axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>            axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>, </span>
<span>            panel.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"lines"</span><span class="op">)</span>, </span>
<span>            legend.position<span class="op">=</span><span class="st">"none"</span>,</span>
<span>            legend.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Average gene-gene correlation"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Average gene-cluster correlation"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/gene_cluster_corr-1.png" width="576"></p>
<p>We can also construct a gene network based on the spatial vector for
the genes.</p>
</div>
<div class="section level5">
<h5 id="gene-network">Gene network<a class="anchor" aria-label="anchor" href="#gene-network"></a>
</h5>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vector_graph</span><span class="op">=</span> <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://r.igraph.org/reference/graph_from_adjacency_matrix.html" class="external-link">graph_from_adjacency_matrix</a></span><span class="op">(</span><span class="va">cor_gene_mt</span>,</span>
<span>                                                mode <span class="op">=</span> <span class="st">"undirected"</span>, </span>
<span>                                                weighted <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                                diag <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vector_graph</span><span class="op">=</span><span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://r.igraph.org/reference/simplify.html" class="external-link">simplify</a></span><span class="op">(</span><span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://r.igraph.org/reference/delete_edges.html" class="external-link">delete_edges</a></span><span class="op">(</span><span class="va">vector_graph</span>, </span>
<span>                        <span class="fu"><a href="https://r.igraph.org/reference/E.html" class="external-link">E</a></span><span class="op">(</span><span class="va">vector_graph</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://r.igraph.org/reference/E.html" class="external-link">E</a></span><span class="op">(</span><span class="va">vector_graph</span><span class="op">)</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">0.7</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">layout</span><span class="op">=</span><span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://r.igraph.org/reference/layout_with_kk.html" class="external-link">layout_with_kk</a></span><span class="op">(</span><span class="va">vector_graph</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the graph</span></span>
<span><span class="fu">ggraph</span><span class="fu">::</span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">vector_graph</span>, layout <span class="op">=</span> <span class="va">layout</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_link.html" class="external-link">geom_edge_link</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>edge_alpha <span class="op">=</span> <span class="va">weight</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_point.html" class="external-link">geom_node_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"lightblue"</span>, size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_text.html" class="external-link">geom_node_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">name</span><span class="op">)</span>, </span>
<span>                    vjust <span class="op">=</span> <span class="fl">1</span>, hjust <span class="op">=</span> <span class="fl">1</span>,size<span class="op">=</span><span class="fl">2</span>,color<span class="op">=</span><span class="st">"orange"</span>, repel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/gene_graph-1.png" width="576"></p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="linear-relationship-between-markers-and-clusters">Linear relationship between markers and clusters<a class="anchor" aria-label="anchor" href="#linear-relationship-between-markers-and-clusters"></a>
</h3>
<p>We assume that the relationship between a marker gene vector its
cluster spatial vector is linear. </p>
<p>Here are several genes and their annotation from the panel. </p>
<table class="table"><tbody>
<tr class="odd">
<td>Gene</td>
<td>Annotation</td>
</tr>
<tr class="even">
<td>ERBB2</td>
<td>Breast cancer cells</td>
</tr>
<tr class="odd">
<td>IL7R</td>
<td>T cells</td>
</tr>
<tr class="even">
<td>MZB1</td>
<td>B cells</td>
</tr>
<tr class="odd">
<td>AQP1</td>
<td>Endothelial</td>
</tr>
<tr class="even">
<td>LUM</td>
<td>Fibroblasts</td>
</tr>
</tbody></table>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genes_lst</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ERBB2"</span>,<span class="st">"AQP1"</span>,<span class="st">"LUM"</span>,<span class="st">"IL7R"</span>,<span class="st">"MZB1"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i_cluster</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"c1"</span>,<span class="st">"c8"</span>,<span class="st">"c3"</span>,<span class="st">"c6"</span>,<span class="st">"c7"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">cluster_vector</span><span class="op">=</span><span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">cluster_mt</span><span class="op">[</span>,<span class="va">i_cluster</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">data_vis</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"cluster"</span>, <span class="va">cluster_vector</span>,</span>
<span>                            <span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">[</span>, <span class="va">genes_lst</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data_vis</span><span class="op">)</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cluster"</span>,<span class="st">"cluster_vector"</span>,<span class="va">genes_lst</span><span class="op">)</span></span>
<span>    <span class="va">data_vis</span><span class="op">=</span><span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">data_vis</span>,variable.name <span class="op">=</span> <span class="st">"genes"</span>,</span>
<span>                            value.name <span class="op">=</span> <span class="st">"gene_vector"</span>,</span>
<span>                            id<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cluster"</span>,<span class="st">"cluster_vector"</span> <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">data_vis</span><span class="op">$</span><span class="va">cluster_vector</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data_vis</span><span class="op">$</span><span class="va">cluster_vector</span><span class="op">)</span></span>
<span>    <span class="va">data_vis</span><span class="op">$</span><span class="va">genes</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">data_vis</span><span class="op">$</span><span class="va">genes</span><span class="op">)</span></span>
<span>    <span class="va">data_vis</span><span class="op">$</span><span class="va">gene_vector</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data_vis</span><span class="op">$</span><span class="va">gene_vector</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_vis</span>, </span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">cluster_vector</span>, y<span class="op">=</span><span class="va">gene_vector</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">genes</span>,scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">6</span><span class="op">)</span>,</span>
<span>                axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">6</span>,angle<span class="op">=</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>                axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, </span>
<span>                panel.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"lines"</span><span class="op">)</span>, </span>
<span>                legend.position<span class="op">=</span><span class="st">"none"</span>,</span>
<span>                legend.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">rel</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">i_cluster</span>,<span class="st">" - cluster vector"</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"gene vector"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/linear%20vector%20to%20vector%20plot-1.png" width="672"><img src="jazzPanda_files/figure-html/linear%20vector%20to%20vector%20plot-2.png" width="672"><img src="jazzPanda_files/figure-html/linear%20vector%20to%20vector%20plot-3.png" width="672"><img src="jazzPanda_files/figure-html/linear%20vector%20to%20vector%20plot-4.png" width="672"><img src="jazzPanda_files/figure-html/linear%20vector%20to%20vector%20plot-5.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="scenario-1-one-sample">Scenario 1: one sample<a class="anchor" aria-label="anchor" href="#scenario-1-one-sample"></a>
</h3>
<p>A straightforward approach to identifying genes that exhibit a linear
correlation with cluster vectors involves computing the Pearson
correlation for each gene with every cluster. To assess the statistical
significance of these correlations, the <code><a href="../reference/compute_permp.html">compute_permp()</a></code>
function can be used to perform permutation testing, generating a
p-value for every pair of gene cluster and cluster vector.</p>
<div class="section level4">
<h4 id="correlation-based-method-to-detect-marker-genes">Correlation-based method to detect marker genes<a class="anchor" aria-label="anchor" href="#correlation-based-method-to-detect-marker-genes"></a>
</h4>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w_x</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w_y</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed_number</span><span class="op">)</span></span>
<span><span class="va">perm_p</span> <span class="op">=</span> <span class="fu"><a href="../reference/compute_permp.html">compute_permp</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">rep1_sub</span>,</span>
<span>                        cluster_info<span class="op">=</span><span class="va">rep1_clusters</span>, </span>
<span>                        perm.size<span class="op">=</span><span class="fl">1000</span>,</span>
<span>                        bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                        bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>,</span>
<span>                        test_genes<span class="op">=</span> <span class="va">all_real_genes</span>,</span>
<span>                        correlation_method <span class="op">=</span> <span class="st">"pearson"</span>, </span>
<span>                        n_cores<span class="op">=</span><span class="fl">1</span>, </span>
<span>                        correction_method<span class="op">=</span><span class="st">"BH"</span>,</span>
<span>                        w_x<span class="op">=</span><span class="va">w_x</span> ,</span>
<span>                        w_y<span class="op">=</span><span class="va">w_y</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># observed correlation for every pair of gene and cluster vector</span></span>
<span><span class="va">obs_corr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">perm_p</span><span class="op">$</span><span class="va">obs.stat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                c5          c8         c3         c2          c1         c4</span></span>
<span><span class="co">## CD68  -0.26037887  0.06259766  0.2360819 -0.4126090 -0.02885842  0.5951329</span></span>
<span><span class="co">## DST    0.47226365 -0.13560127 -0.4095928  0.4282446  0.51097133 -0.3263375</span></span>
<span><span class="co">## EPCAM -0.11473423 -0.35287011 -0.5724549  0.3454557  0.86438353 -0.3496045</span></span>
<span><span class="co">## ERBB2  0.08159437 -0.34437593 -0.5542681  0.6259111  0.69027586 -0.3613350</span></span>
<span><span class="co">## FOXA1 -0.12850033 -0.33199825 -0.5574530  0.2897598  0.90412737 -0.3504568</span></span>
<span><span class="co">## KRT7  -0.15416917 -0.29951312 -0.5314679  0.1429028  0.93356172 -0.2936468</span></span>
<span><span class="co">##               c6         c7</span></span>
<span><span class="co">## CD68   0.2343318  0.1504930</span></span>
<span><span class="co">## DST   -0.3835009 -0.4094809</span></span>
<span><span class="co">## EPCAM -0.4591613 -0.4444322</span></span>
<span><span class="co">## ERBB2 -0.4587071 -0.4455121</span></span>
<span><span class="co">## FOXA1 -0.4489792 -0.4284400</span></span>
<span><span class="co">## KRT7  -0.4350973 -0.4261451</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># permutation adjusted p-value for every pair of gene and cluster vector</span></span>
<span><span class="va">perm_res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">perm_p</span><span class="op">$</span><span class="va">perm.pval.adj</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                c5        c8        c3          c2          c1          c4</span></span>
<span><span class="co">## CD68  1.000000000 0.7675658 0.1758242 1.000000000 1.000000000 0.003996004</span></span>
<span><span class="co">## DST   0.006660007 1.0000000 1.0000000 0.006660007 0.003996004 1.000000000</span></span>
<span><span class="co">## EPCAM 1.000000000 1.0000000 1.0000000 0.135864136 0.003996004 1.000000000</span></span>
<span><span class="co">## ERBB2 1.000000000 1.0000000 1.0000000 0.006660007 0.003996004 1.000000000</span></span>
<span><span class="co">## FOXA1 1.000000000 1.0000000 1.0000000 0.462870463 0.003996004 1.000000000</span></span>
<span><span class="co">## KRT7  1.000000000 1.0000000 1.0000000 1.000000000 0.003996004 1.000000000</span></span>
<span><span class="co">##               c6        c7</span></span>
<span><span class="co">## CD68  0.06455083 0.2651894</span></span>
<span><span class="co">## DST   1.00000000 1.0000000</span></span>
<span><span class="co">## EPCAM 1.00000000 1.0000000</span></span>
<span><span class="co">## ERBB2 1.00000000 1.0000000</span></span>
<span><span class="co">## FOXA1 1.00000000 1.0000000</span></span>
<span><span class="co">## KRT7  1.00000000 1.0000000</span></span></code></pre>
<div class="section level5">
<h5 id="visualise-top-marker-genes-detected-by-correlation-approach">Visualise top marker genes detected by correlation approach<a class="anchor" aria-label="anchor" href="#visualise-top-marker-genes-detected-by-correlation-approach"></a>
</h5>
<p>Genes with a significant adjusted p-value are considered as marker
genes for the corresponding cluster. We can rank the marker genes by the
observed correlationand plot the transcript detection coordinates for
the top three marker genes for every cluster.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_df_1000</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">perm_p</span><span class="op">$</span><span class="va">perm.pval.adj</span><span class="op">)</span></span>
<span><span class="va">res_df_1000</span><span class="op">$</span><span class="va">gene</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">res_df_1000</span><span class="op">)</span></span>
<span><span class="va">cluster_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">cluster_names</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">perm_sig</span> <span class="op">=</span> <span class="va">res_df_1000</span><span class="op">[</span><span class="va">res_df_1000</span><span class="op">[</span>,<span class="va">cl</span><span class="op">]</span><span class="op">&lt;</span><span class="fl">0.05</span>,<span class="op">]</span></span>
<span>    <span class="co"># define a cutoff value based on 75% quantile </span></span>
<span>    <span class="va">obs_cutoff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">[</span>, <span class="va">cl</span><span class="op">]</span>, <span class="fl">0.75</span><span class="op">)</span></span>
<span>    <span class="va">perm_cl</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">[</span><span class="va">perm_res</span><span class="op">[</span>,<span class="va">cl</span><span class="op">]</span><span class="op">&lt;</span><span class="fl">0.05</span>,<span class="op">]</span><span class="op">)</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">[</span><span class="va">obs_corr</span><span class="op">[</span>, <span class="va">cl</span><span class="op">]</span><span class="op">&gt;</span><span class="va">obs_cutoff</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">inters</span><span class="op">=</span><span class="va">perm_cl</span></span>
<span>    <span class="va">rounded_val</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">[</span><span class="va">inters</span>,<span class="va">cl</span><span class="op">]</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>gene<span class="op">=</span><span class="va">inters</span>, value<span class="op">=</span><span class="va">rounded_val</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">=</span><span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">inters_df</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span>,<span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>,sep<span class="op">=</span><span class="st">": "</span><span class="op">)</span></span>
<span>    <span class="va">curr_genes</span> <span class="op">=</span> <span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">feature_name</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span></span>
<span>    <span class="va">data_vis</span> <span class="op">=</span><span class="va">rep1_transcripts</span><span class="op">[</span><span class="va">curr_genes</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"feature_name"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">data_vis</span><span class="op">$</span><span class="va">text</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">data_vis</span><span class="op">$</span><span class="va">feature_name</span>,<span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span>,</span>
<span>                                <span class="st">"text"</span><span class="op">]</span></span>
<span>    <span class="va">data_vis</span><span class="op">$</span><span class="va">text</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">data_vis</span><span class="op">$</span><span class="va">text</span>, levels<span class="op">=</span><span class="va">inters_df</span><span class="op">$</span><span class="va">text</span><span class="op">)</span></span>
<span>    <span class="va">p1</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_vis</span>,</span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.01</span>,color<span class="op">=</span><span class="st">"maroon4"</span><span class="op">)</span><span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">text</span>,ncol<span class="op">=</span><span class="fl">10</span>, scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>height<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                <span class="va">defined_theme</span></span>
<span>    <span class="va">cl_pt</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">rep1_clusters</span><span class="op">[</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">cluster</span><span class="op">==</span><span class="va">cl</span>, <span class="op">]</span>,</span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitterdodge.html" class="external-link">position_jitterdodge</a></span><span class="op">(</span>jitter.width<span class="op">=</span><span class="fl">0</span>, </span>
<span>                                            jitter.height<span class="op">=</span><span class="fl">0</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">cluster</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="va">defined_theme</span></span>
<span>    <span class="va">lyt</span> <span class="op">&lt;-</span> <span class="va">cl_pt</span> <span class="op">|</span> <span class="va">p1</span></span>
<span>    <span class="va">layout_design</span> <span class="op">&lt;-</span> <span class="va">lyt</span> <span class="op">+</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">layout_design</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/rep1%20permutation%20vis-1.png" width="576"><img src="jazzPanda_files/figure-html/rep1%20permutation%20vis-2.png" width="576"><img src="jazzPanda_files/figure-html/rep1%20permutation%20vis-3.png" width="576"><img src="jazzPanda_files/figure-html/rep1%20permutation%20vis-4.png" width="576"><img src="jazzPanda_files/figure-html/rep1%20permutation%20vis-5.png" width="576"><img src="jazzPanda_files/figure-html/rep1%20permutation%20vis-6.png" width="576"><img src="jazzPanda_files/figure-html/rep1%20permutation%20vis-7.png" width="576"><img src="jazzPanda_files/figure-html/rep1%20permutation%20vis-8.png" width="576"></p>
</div>
<div class="section level5">
<h5 id="visualise-cluster-vector-and-the-top-marker-genes-at-spatial-vector-level">Visualise cluster vector and the top marker genes at spatial vector
level<a class="anchor" aria-label="anchor" href="#visualise-cluster-vector-and-the-top-marker-genes-at-spatial-vector-level"></a>
</h5>
<p>To check the linear relationship between the cluster vector and the
marker gene vectors, we can plot the cluster vector on x-axis, and the
marker gene vector on y-axis. The figure below shows the relationship
between the cluster vector and the top marker gene vectors detected by
correlation approach.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">plot_lst</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">cluster_names</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">perm_sig</span> <span class="op">=</span> <span class="va">res_df_1000</span><span class="op">[</span><span class="va">res_df_1000</span><span class="op">[</span>,<span class="va">cl</span><span class="op">]</span><span class="op">&lt;</span><span class="fl">0.05</span>,<span class="op">]</span></span>
<span>    <span class="va">curr_cell_type</span> <span class="op">=</span> <span class="va">all_celltypes</span><span class="op">[</span><span class="va">all_celltypes</span><span class="op">$</span><span class="va">cluster</span><span class="op">==</span><span class="va">cl</span>,<span class="st">"anno"</span><span class="op">]</span></span>
<span>    <span class="va">obs_cutoff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">[</span>, <span class="va">cl</span><span class="op">]</span>, <span class="fl">0.75</span><span class="op">)</span></span>
<span>    <span class="va">perm_cl</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">[</span><span class="va">perm_res</span><span class="op">[</span>,<span class="va">cl</span><span class="op">]</span><span class="op">&lt;</span><span class="fl">0.05</span>,<span class="op">]</span><span class="op">)</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">[</span><span class="va">obs_corr</span><span class="op">[</span>, <span class="va">cl</span><span class="op">]</span><span class="op">&gt;</span><span class="va">obs_cutoff</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">inters</span><span class="op">=</span><span class="va">perm_cl</span></span>
<span>    <span class="va">rounded_val</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">[</span><span class="va">inters</span>,<span class="va">cl</span><span class="op">]</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>gene<span class="op">=</span><span class="va">inters</span>, value<span class="op">=</span><span class="va">rounded_val</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">=</span><span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span>,<span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>,sep<span class="op">=</span><span class="st">": "</span><span class="op">)</span></span>
<span>    <span class="va">mk_gene</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">)</span><span class="op">)</span>,<span class="st">"gene"</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mk_gene</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">dff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">cluster_mt</span><span class="op">[</span>,<span class="va">cl</span><span class="op">]</span>,</span>
<span>                                    <span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">[</span>,<span class="va">mk_gene</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dff</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cluster"</span>, <span class="va">mk_gene</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="va">dff</span><span class="op">$</span><span class="va">vector_id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">grid_length</span> <span class="op">*</span> <span class="va">grid_length</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">long_df</span> <span class="op">&lt;-</span> <span class="va">dff</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cluster</span>, <span class="va">vector_id</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"gene"</span>, </span>
<span>                                values_to <span class="op">=</span> <span class="st">"vector_count"</span><span class="op">)</span></span>
<span>        <span class="va">long_df</span><span class="op">$</span><span class="va">gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">long_df</span><span class="op">$</span><span class="va">gene</span>, levels<span class="op">=</span><span class="va">mk_gene</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="va">p</span><span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">long_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cluster</span>, y <span class="op">=</span> <span class="va">vector_count</span> <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span> size<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">gene</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"cluster vector "</span>, <span class="va">curr_cell_type</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>, </span>
<span>                    y <span class="op">=</span> <span class="st">"marker gene vectors"</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                        override.aes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>                    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">rel</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    axis.line<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>                    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                    axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    axis.ticks<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>                    panel.border <span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                                fill<span class="op">=</span><span class="cn">NA</span>, linewidth<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>        <span class="va">plot_lst</span><span class="op">[[</span><span class="va">cl</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">p</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">combined_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">plot_lst</span>, </span>
<span>                            ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                            common.legend <span class="op">=</span> <span class="cn">FALSE</span>, legend <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_plot</span> </span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/vvplot_corr-1.png" width="768">
The other method to identify linearly correlated genes for each cluster
is to construct a linear model for each gene. We can use the
<code>lasso_markers</code> function to get the most relevant cluster
label for every gene.</p>
</div>
</div>
<div class="section level4">
<h4 id="linear-modeling-approach-to-detect-marker-genes">Linear modeling approach to detect marker genes<a class="anchor" aria-label="anchor" href="#linear-modeling-approach-to-detect-marker-genes"></a>
</h4>
<p>We can create spatial vectors for negative control genes and include
them as background noise â€œclustersâ€.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">probe_nm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">rep1_nc_data</span><span class="op">[</span><span class="va">rep1_nc_data</span><span class="op">$</span><span class="va">category</span><span class="op">==</span><span class="st">"probe"</span>,<span class="st">"feature_name"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">codeword_nm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">rep1_nc_data</span><span class="op">[</span><span class="va">rep1_nc_data</span><span class="op">$</span><span class="va">category</span><span class="op">==</span><span class="st">"codeword"</span>,</span>
<span>                                    <span class="st">"feature_name"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">rep1_nc_vectors</span> <span class="op">=</span> <span class="fu"><a href="../reference/create_genesets.html">create_genesets</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">rep1_neg</span>,sample_names<span class="op">=</span><span class="st">"rep1"</span>,</span>
<span>                                    name_lst<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>probe<span class="op">=</span><span class="va">probe_nm</span>, </span>
<span>                                                codeword<span class="op">=</span><span class="va">codeword_nm</span><span class="op">)</span>, </span>
<span>                                    bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                    bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>, </span>
<span>                                    w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span>,</span>
<span>                                    cluster_info <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed_number</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rep1_lasso_with_nc</span> <span class="op">=</span> <span class="fu"><a href="../reference/lasso_markers.html">lasso_markers</a></span><span class="op">(</span>gene_mt<span class="op">=</span><span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">gene_mt</span>,</span>
<span>                                    cluster_mt <span class="op">=</span> <span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">cluster_mt</span>,</span>
<span>                                    sample_names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rep1"</span><span class="op">)</span>,</span>
<span>                                    keep_positive<span class="op">=</span><span class="cn">TRUE</span>, </span>
<span>                                    coef_cutoff<span class="op">=</span><span class="fl">0.2</span>,</span>
<span>                                    background<span class="op">=</span><span class="va">rep1_nc_vectors</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rep1_top_df_nc</span> <span class="op">=</span> <span class="va">rep1_lasso_with_nc</span><span class="op">$</span><span class="va">lasso_top_result</span></span>
<span><span class="co"># the top result table </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">rep1_top_df_nc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        gene top_cluster  glm_coef   pearson max_gg_corr max_gc_corr</span></span>
<span><span class="co">## CD68   CD68          c4  4.468619 0.5951329   0.5143408   0.5951329</span></span>
<span><span class="co">## DST     DST          c1  2.035571 0.5109713   0.6765032   0.5109713</span></span>
<span><span class="co">## EPCAM EPCAM          c1 10.590911 0.8643835   0.9547929   0.8643835</span></span>
<span><span class="co">## ERBB2 ERBB2          c1 14.508203 0.6902759   0.8864028   0.6902759</span></span>
<span><span class="co">## FOXA1 FOXA1          c1 10.148961 0.9041274   0.9547929   0.9041274</span></span>
<span><span class="co">## KRT7   KRT7          c1 14.177664 0.9335617   0.9540827   0.9335617</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># the full result table </span></span>
<span><span class="va">rep1_full_df</span> <span class="op">=</span> <span class="va">rep1_lasso_with_nc</span><span class="op">$</span><span class="va">lasso_full_result</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">rep1_full_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      gene cluster glm_coef      p_value   pearson max_gg_corr max_gc_corr</span></span>
<span><span class="co">## 31   AQP1      c8 6.998951 3.650999e-25 0.8270796   0.8442294   0.8270796</span></span>
<span><span class="co">## 32   AQP1      c6 1.702569 9.317924e-05 0.3209543   0.8442294   0.8270796</span></span>
<span><span class="co">## 33   AQP1      c3 1.013530 2.956703e-03 0.2099349   0.8442294   0.8270796</span></span>
<span><span class="co">## 36 CCDC80      c3 3.872311 3.842116e-20 0.7163637   0.8086714   0.7163637</span></span>
<span><span class="co">## 37 CCDC80      c7 1.512364 4.072797e-02 0.2349379   0.8086714   0.7163637</span></span>
<span><span class="co">## 1    CD68      c4 4.468619 2.344267e-11 0.5951329   0.5143408   0.5951329</span></span></code></pre>
<div class="section level5">
<h5 id="visualise-top-marker-genes-detected-by-linear-modelling-approach">Visualise top marker genes detected by linear modelling
approach<a class="anchor" aria-label="anchor" href="#visualise-top-marker-genes-detected-by-linear-modelling-approach"></a>
</h5>
<p>We can rank the marker genes by its linear model coefficient to the
cluster ans plot the transcript detection coordinates for the top three
marker genes for every cluster.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">cluster_names</span>,<span class="st">"NoSig"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">inters</span><span class="op">=</span><span class="va">rep1_top_df_nc</span><span class="op">[</span><span class="va">rep1_top_df_nc</span><span class="op">$</span><span class="va">top_cluster</span><span class="op">==</span><span class="va">cl</span>,<span class="st">"gene"</span><span class="op">]</span></span>
<span>    <span class="va">rounded_val</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">rep1_top_df_nc</span><span class="op">[</span><span class="va">inters</span>,<span class="st">"glm_coef"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                                    digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>gene<span class="op">=</span><span class="va">inters</span>, value<span class="op">=</span><span class="va">rounded_val</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">=</span><span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span>,<span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>,sep<span class="op">=</span><span class="st">": "</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inters</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">inters_df</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span>        <span class="va">inters</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span></span>
<span>        <span class="va">iters_rep1</span><span class="op">=</span> <span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">feature_name</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">inters</span></span>
<span>        <span class="va">vis_r1</span> <span class="op">=</span><span class="va">rep1_transcripts</span><span class="op">[</span><span class="va">iters_rep1</span>,</span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"feature_name"</span><span class="op">)</span><span class="op">]</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">feature_name</span>,<span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span>,</span>
<span>                                <span class="st">"value"</span><span class="op">]</span></span>
<span>        <span class="co">#vis_r1=vis_r1[order(vis_r1$value,decreasing = TRUE),]</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">feature_name</span>,</span>
<span>                                    <span class="va">vis_r1</span><span class="op">$</span><span class="va">value</span>,sep<span class="op">=</span><span class="st">": "</span><span class="op">)</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span>, levels <span class="op">=</span> <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span><span class="op">)</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">sample</span><span class="op">=</span><span class="st">"rep1"</span></span>
<span>        <span class="va">p1</span><span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">vis_r1</span>,</span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.01</span>,color<span class="op">=</span><span class="st">"maroon4"</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">text_label</span>,ncol<span class="op">=</span><span class="fl">10</span>, scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>height<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="va">defined_theme</span></span>
<span>        <span class="va">cl_pt</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">rep1_clusters</span><span class="op">[</span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">cluster</span><span class="op">==</span><span class="va">cl</span>, <span class="op">]</span>,</span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitterdodge.html" class="external-link">position_jitterdodge</a></span><span class="op">(</span>jitter.width<span class="op">=</span><span class="fl">0</span>, </span>
<span>                                            jitter.height<span class="op">=</span><span class="fl">0</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">cluster</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="va">defined_theme</span></span>
<span>        <span class="va">lyt</span> <span class="op">&lt;-</span> <span class="va">cl_pt</span> <span class="op">|</span> <span class="va">p1</span></span>
<span>        <span class="va">layout_design</span> <span class="op">&lt;-</span> <span class="va">lyt</span> <span class="op">+</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">layout_design</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">}</span></span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/lasso-rep1%20vis-1.png" width="576"><img src="jazzPanda_files/figure-html/lasso-rep1%20vis-2.png" width="576"><img src="jazzPanda_files/figure-html/lasso-rep1%20vis-3.png" width="576"><img src="jazzPanda_files/figure-html/lasso-rep1%20vis-4.png" width="576"><img src="jazzPanda_files/figure-html/lasso-rep1%20vis-5.png" width="576"><img src="jazzPanda_files/figure-html/lasso-rep1%20vis-6.png" width="576"><img src="jazzPanda_files/figure-html/lasso-rep1%20vis-7.png" width="576"></p>
</div>
<div class="section level5">
<h5 id="visualise-cluster-vector-and-the-top-marker-genes-at-spatial-vector-level-1">Visualise cluster vector and the top marker genes at spatial vector
level<a class="anchor" aria-label="anchor" href="#visualise-cluster-vector-and-the-top-marker-genes-at-spatial-vector-level-1"></a>
</h5>
<p>We can plot the cluster vector on x-axis, and the marker gene vectors
(detected by the linear modelling approach) on y-axis to validate the
linear relationship assumption between the cluster vector and the marker
gene vectors.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">plot_lst</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">cluster_names</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">curr_cell_type</span> <span class="op">=</span> <span class="va">all_celltypes</span><span class="op">[</span><span class="va">all_celltypes</span><span class="op">$</span><span class="va">cluster</span><span class="op">==</span><span class="va">cl</span>,<span class="st">"anno"</span><span class="op">]</span></span>
<span>    <span class="va">inters</span><span class="op">=</span><span class="va">rep1_top_df_nc</span><span class="op">[</span><span class="va">rep1_top_df_nc</span><span class="op">$</span><span class="va">top_cluster</span><span class="op">==</span><span class="va">cl</span>,<span class="st">"gene"</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inters</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">rounded_val</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">rep1_top_df_nc</span><span class="op">[</span><span class="va">inters</span>,<span class="st">"glm_coef"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                                digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>        <span class="va">inters_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>gene<span class="op">=</span><span class="va">inters</span>, value<span class="op">=</span><span class="va">rounded_val</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>        <span class="va">inters_df</span><span class="op">=</span><span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span></span>
<span>        <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span>,<span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>,sep<span class="op">=</span><span class="st">": "</span><span class="op">)</span></span>
<span>    </span>
<span>        <span class="va">inters_df</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span>        <span class="va">mk_gene</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span></span>
<span></span>
<span>        <span class="va">dff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">cluster_mt</span><span class="op">[</span>,<span class="va">cl</span><span class="op">]</span>,</span>
<span>                                <span class="va">rep1_sq10_vectors</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">[</span>,<span class="va">mk_gene</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dff</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cluster"</span>, <span class="va">mk_gene</span><span class="op">)</span></span>
<span>        <span class="va">dff</span><span class="op">$</span><span class="va">vector_id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">grid_length</span> <span class="op">*</span> <span class="va">grid_length</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">long_df</span> <span class="op">&lt;-</span> <span class="va">dff</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cluster</span>, <span class="va">vector_id</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"gene"</span>, </span>
<span>                        values_to <span class="op">=</span> <span class="st">"vector_count"</span><span class="op">)</span></span>
<span>        <span class="va">long_df</span><span class="op">$</span><span class="va">gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">long_df</span><span class="op">$</span><span class="va">gene</span>, levels<span class="op">=</span><span class="va">mk_gene</span><span class="op">)</span></span>
<span>        <span class="va">p</span><span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">long_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cluster</span>, y <span class="op">=</span> <span class="va">vector_count</span> <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span> size<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">gene</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"cluster vector "</span>, <span class="va">curr_cell_type</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>, </span>
<span>                    y <span class="op">=</span> <span class="st">"marker gene vectors"</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                        override.aes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>                    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">rel</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    axis.line<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>                    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                    axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    axis.ticks<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>                    panel.border <span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                                fill<span class="op">=</span><span class="cn">NA</span>, linewidth<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="va">plot_lst</span><span class="op">[[</span><span class="va">cl</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">p</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">combined_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">plot_lst</span>, </span>
<span>                            ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                            common.legend <span class="op">=</span> <span class="cn">FALSE</span>, legend <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_plot</span> </span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/vvplot_glm-1.png" width="768"></p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="scenario-2-multiple-samples">Scenario 2: multiple samples<a class="anchor" aria-label="anchor" href="#scenario-2-multiple-samples"></a>
</h3>
<p>Load the replicate 2 from sample 1.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">rep2_sub</span>, <span class="va">rep2_clusters</span>, <span class="va">rep2_neg</span><span class="op">)</span></span>
<span><span class="va">rep2_clusters</span><span class="op">$</span><span class="va">cluster</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">rep2_clusters</span><span class="op">$</span><span class="va">cluster</span>,</span>
<span>                            levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"c"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rep1_clusters</span><span class="op">$</span><span class="va">cells</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">rep1_clusters</span><span class="op">)</span>,<span class="st">"_1"</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">rep2_clusters</span><span class="op">$</span><span class="va">cells</span> <span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">rep2_clusters</span><span class="op">)</span>,<span class="st">"_2"</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">rep_clusters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">rep1_clusters</span>,<span class="va">rep2_clusters</span><span class="op">)</span></span>
<span><span class="va">rep_clusters</span><span class="op">$</span><span class="va">cluster</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">rep_clusters</span><span class="op">$</span><span class="va">cluster</span>,</span>
<span>                            levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"c"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">rep_clusters</span><span class="op">$</span><span class="va">sample</span>, <span class="va">rep_clusters</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       </span></span>
<span><span class="co">##         c1  c2  c3  c4  c5  c6  c7  c8</span></span>
<span><span class="co">##   rep1 745 205 221 127  87 176  45  99</span></span>
<span><span class="co">##   rep2  27 476 313 190 360 256  99  94</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># record the transcript coordinates for rep2</span></span>
<span><span class="va">rep2_transcripts</span> <span class="op">&lt;-</span><span class="fu">BumpyMatrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BumpyMatrix/man/unsplitAsDataFrame.html" class="external-link">unsplitAsDataFrame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-assays.html" class="external-link">molecules</a></span><span class="op">(</span><span class="va">rep2_sub</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rep2_transcripts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">rep2_transcripts</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rep2_transcripts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"feature_name"</span>,<span class="st">"cell_id"</span>,<span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span></span>
<span><span class="co"># record the negative control transcript coordinates for rep2</span></span>
<span><span class="va">rep2_nc_data</span> <span class="op">&lt;-</span><span class="fu">BumpyMatrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BumpyMatrix/man/unsplitAsDataFrame.html" class="external-link">unsplitAsDataFrame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-assays.html" class="external-link">molecules</a></span><span class="op">(</span><span class="va">rep2_neg</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rep2_nc_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">rep2_nc_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rep2_nc_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"feature_name"</span>,<span class="st">"cell_id"</span>,<span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"category"</span><span class="op">)</span></span></code></pre></div>
<div class="section level5">
<h5 id="visualise-the-clusters">Visualise the clusters<a class="anchor" aria-label="anchor" href="#visualise-the-clusters"></a>
</h5>
<p>We can plot the coordinates of cells for every cluster in every
replicate</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">rep_clusters</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitterdodge.html" class="external-link">position_jitterdodge</a></span><span class="op">(</span>jitter.width<span class="op">=</span><span class="fl">0</span>, </span>
<span>                                                jitter.height<span class="op">=</span><span class="fl">0</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">sample</span><span class="op">~</span><span class="va">cluster</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#FC8D62"</span>,<span class="st">"#66C2A5"</span> ,<span class="st">"#8DA0CB"</span>,<span class="st">"#E78AC3"</span>,</span>
<span>                                <span class="st">"#A6D854"</span>,<span class="st">"skyblue"</span>,<span class="st">"purple3"</span>,<span class="st">"#E5C498"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"cluster"</span>, nrow <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        override.aes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>            axis.line<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            axis.ticks<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            panel.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            panel.border<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            panel.grid.major<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            panel.grid.minor<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            plot.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>            legend.position<span class="op">=</span><span class="st">"none"</span>,</span>
<span>            legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>            strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">rel</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/tworep%20cluster%20vis-1.png" width="768"></p>
<p>When we have multiple replicates in the dataset, we can find marker
genes by providing additional sample information as the input for the
function <code>lasso_markers</code>.</p>
</div>
<div class="section level4">
<h4 id="linear-modeling-approach-to-detect-marker-genes-1">Linear modeling approach to detect marker genes<a class="anchor" aria-label="anchor" href="#linear-modeling-approach-to-detect-marker-genes-1"></a>
</h4>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w_x</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep2_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep_clusters</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep2_transcripts</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep_clusters</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w_y</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep2_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">rep_clusters</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep2_transcripts</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rep_clusters</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">grid_length</span><span class="op">=</span><span class="fl">10</span></span>
<span><span class="va">twosample_spe</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">rep1_sub</span>, <span class="va">rep2_sub</span><span class="op">)</span></span>
<span><span class="co"># get spatial vectors</span></span>
<span><span class="va">two_rep_vectors</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_vectors.html">get_vectors</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">twosample_spe</span>,</span>
<span>                                sample_names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rep1"</span>,<span class="st">"rep2"</span><span class="op">)</span>,</span>
<span>                                cluster_info <span class="op">=</span> <span class="va">rep_clusters</span>, bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">grid_length</span>, <span class="va">grid_length</span><span class="op">)</span>,</span>
<span>                                test_genes <span class="op">=</span> <span class="va">all_real_genes</span> , </span>
<span>                                w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">twosample_neg_spe</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">rep1_neg</span>, <span class="va">rep2_neg</span><span class="op">)</span></span>
<span></span>
<span><span class="va">probe_nm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rep1_nc_data</span><span class="op">[</span><span class="va">rep1_nc_data</span><span class="op">$</span><span class="va">category</span><span class="op">==</span><span class="st">"probe"</span>,</span>
<span>                                <span class="st">"feature_name"</span><span class="op">]</span>,</span>
<span>                <span class="va">rep2_nc_data</span><span class="op">[</span><span class="va">rep2_nc_data</span><span class="op">$</span><span class="va">category</span><span class="op">==</span><span class="st">"probe"</span>,<span class="st">"feature_name"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">codeword_nm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rep1_nc_data</span><span class="op">[</span><span class="va">rep1_nc_data</span><span class="op">$</span><span class="va">category</span><span class="op">==</span><span class="st">"codeword"</span>,</span>
<span>                                <span class="st">"feature_name"</span><span class="op">]</span>,</span>
<span>            <span class="va">rep2_nc_data</span><span class="op">[</span><span class="va">rep2_nc_data</span><span class="op">$</span><span class="va">category</span><span class="op">==</span><span class="st">"codeword"</span>,<span class="st">"feature_name"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">two_rep_nc_vectors</span> <span class="op">=</span> <span class="fu"><a href="../reference/create_genesets.html">create_genesets</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">twosample_neg_spe</span>,</span>
<span>                                    sample_names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rep1"</span>,<span class="st">"rep2"</span><span class="op">)</span>,</span>
<span>                                    name_lst<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>probe<span class="op">=</span><span class="va">probe_nm</span>, </span>
<span>                                                codeword<span class="op">=</span><span class="va">codeword_nm</span><span class="op">)</span>,</span>
<span>                                    bin_type<span class="op">=</span><span class="st">"square"</span>,</span>
<span>                                    bin_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, </span>
<span>                                    w_x<span class="op">=</span><span class="va">w_x</span>, w_y<span class="op">=</span><span class="va">w_y</span>,</span>
<span>                                    cluster_info <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed_number</span><span class="op">)</span></span>
<span><span class="va">two_rep_lasso_with_nc</span> <span class="op">=</span> <span class="fu"><a href="../reference/lasso_markers.html">lasso_markers</a></span><span class="op">(</span>gene_mt<span class="op">=</span><span class="va">two_rep_vectors</span><span class="op">$</span><span class="va">gene_mt</span>,</span>
<span>                                    cluster_mt <span class="op">=</span> <span class="va">two_rep_vectors</span><span class="op">$</span><span class="va">cluster_mt</span>,</span>
<span>                                    sample_names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rep1"</span>,<span class="st">"rep2"</span><span class="op">)</span>,</span>
<span>                                    keep_positive<span class="op">=</span><span class="cn">TRUE</span>, </span>
<span>                                    coef_cutoff<span class="op">=</span><span class="fl">0.2</span>,</span>
<span>                                    background<span class="op">=</span><span class="va">two_rep_nc_vectors</span>,n_fold <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">tworep_res</span><span class="op">=</span><span class="va">two_rep_lasso_with_nc</span><span class="op">$</span><span class="va">lasso_top_result</span></span>
<span><span class="va">tworep_res</span><span class="op">$</span><span class="va">celltype</span> <span class="op">=</span> <span class="va">rep_clusters</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">tworep_res</span><span class="op">$</span><span class="va">top_cluster</span>,</span>
<span>                                            <span class="va">rep_clusters</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span>,<span class="st">"anno"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">tworep_res</span><span class="op">$</span><span class="va">top_cluster</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## c1 c2 c3 c4 c5 c6 c7 c8 </span></span>
<span><span class="co">##  3  2  3  3  2  2  2  3</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">tworep_res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        gene top_cluster  glm_coef   pearson max_gg_corr max_gc_corr</span></span>
<span><span class="co">## CD68   CD68          c4  2.822240 0.6902781   0.6540004   0.6902781</span></span>
<span><span class="co">## DST     DST          c5  7.431511 0.8603213   0.8203238   0.8603213</span></span>
<span><span class="co">## EPCAM EPCAM          c1  9.306909 0.6247635   0.9398823   0.6247635</span></span>
<span><span class="co">## ERBB2 ERBB2          c2 21.682425 0.7811584   0.9072989   0.7811584</span></span>
<span><span class="co">## FOXA1 FOXA1          c1  8.666483 0.5577500   0.9398823   0.6031995</span></span>
<span><span class="co">## KRT7   KRT7          c1 12.191969 0.6529267   0.9155480   0.6529267</span></span>
<span><span class="co">##            celltype</span></span>
<span><span class="co">## CD68    Macrophages</span></span>
<span><span class="co">## DST   Myoepithelial</span></span>
<span><span class="co">## EPCAM         Tumor</span></span>
<span><span class="co">## ERBB2          DCIS</span></span>
<span><span class="co">## FOXA1         Tumor</span></span>
<span><span class="co">## KRT7          Tumor</span></span></code></pre>
<div class="section level5">
<h5 id="visualise-the-top-marker-genes-for-each-cluster">Visualise the top marker genes for each cluster<a class="anchor" aria-label="anchor" href="#visualise-the-top-marker-genes-for-each-cluster"></a>
</h5>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">all_celltypes</span><span class="op">$</span><span class="va">anno</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">inters</span><span class="op">=</span><span class="va">tworep_res</span><span class="op">[</span><span class="va">tworep_res</span><span class="op">$</span><span class="va">celltype</span><span class="op">==</span><span class="va">cl</span>,<span class="st">"gene"</span><span class="op">]</span></span>
<span>    <span class="va">rounded_val</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">tworep_res</span><span class="op">[</span><span class="va">inters</span>,<span class="st">"glm_coef"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                        digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>gene<span class="op">=</span><span class="va">inters</span>, value<span class="op">=</span><span class="va">rounded_val</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">=</span><span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span>,<span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>,sep<span class="op">=</span><span class="st">": "</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inters</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">inters_df</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span>        <span class="va">inters</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span></span>
<span>        <span class="va">iters_rep1</span><span class="op">=</span> <span class="va">rep1_transcripts</span><span class="op">$</span><span class="va">feature_name</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">inters</span></span>
<span>        <span class="va">vis_r1</span> <span class="op">=</span><span class="va">rep1_transcripts</span><span class="op">[</span><span class="va">iters_rep1</span>,</span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"feature_name"</span><span class="op">)</span><span class="op">]</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">feature_name</span>,<span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span>,</span>
<span>                                <span class="st">"value"</span><span class="op">]</span></span>
<span>        <span class="va">vis_r1</span><span class="op">=</span><span class="va">vis_r1</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">value</span>,decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">feature_name</span>,</span>
<span>                                    <span class="va">vis_r1</span><span class="op">$</span><span class="va">value</span>,sep<span class="op">=</span><span class="st">": "</span><span class="op">)</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span><span class="op">)</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">sample</span><span class="op">=</span><span class="st">"rep1"</span></span>
<span>        <span class="va">iters_rep2</span><span class="op">=</span> <span class="va">rep2_transcripts</span><span class="op">$</span><span class="va">feature_name</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">inters</span></span>
<span>        <span class="va">vis_r2</span> <span class="op">=</span><span class="va">rep2_transcripts</span><span class="op">[</span><span class="va">iters_rep2</span>,</span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"feature_name"</span><span class="op">)</span><span class="op">]</span></span>
<span>        <span class="va">vis_r2</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">vis_r2</span><span class="op">$</span><span class="va">feature_name</span>,<span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span>,</span>
<span>                                <span class="st">"value"</span><span class="op">]</span></span>
<span>        <span class="va">vis_r2</span><span class="op">=</span><span class="va">vis_r2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">vis_r2</span><span class="op">$</span><span class="va">value</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span></span>
<span>        <span class="va">vis_r2</span><span class="op">$</span><span class="va">text_label</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">vis_r2</span><span class="op">$</span><span class="va">feature_name</span>,</span>
<span>                                <span class="va">vis_r2</span><span class="op">$</span><span class="va">value</span>,sep<span class="op">=</span><span class="st">": "</span><span class="op">)</span></span>
<span>        <span class="va">vis_r2</span><span class="op">$</span><span class="va">text_label</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">vis_r2</span><span class="op">$</span><span class="va">text_label</span><span class="op">)</span></span>
<span>        <span class="va">vis_r2</span><span class="op">$</span><span class="va">sample</span><span class="op">=</span><span class="st">"rep2"</span></span>
<span>        <span class="va">p1</span><span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">vis_r1</span>,</span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.01</span>,color<span class="op">=</span><span class="st">"maroon4"</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">sample</span><span class="op">~</span><span class="va">text_label</span>, scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>height<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="va">defined_theme</span></span>
<span>        <span class="va">p2</span><span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">vis_r2</span>,</span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.01</span>,color<span class="op">=</span><span class="st">"maroon4"</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">sample</span><span class="op">~</span><span class="va">text_label</span>,scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>height<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="va">defined_theme</span></span>
<span>        </span>
<span>        <span class="va">cl_pt</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">rep_clusters</span><span class="op">[</span><span class="va">rep_clusters</span><span class="op">$</span><span class="va">anno</span><span class="op">==</span><span class="va">cl</span>, <span class="op">]</span>,</span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitterdodge.html" class="external-link">position_jitterdodge</a></span><span class="op">(</span>jitter.width<span class="op">=</span><span class="fl">0</span>, </span>
<span>                                            jitter.height<span class="op">=</span><span class="fl">0</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">sample</span><span class="op">~</span><span class="va">cluster</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="va">defined_theme</span></span>
<span>        <span class="va">lyt</span> <span class="op">&lt;-</span> <span class="va">cl_pt</span> <span class="op">|</span> <span class="op">(</span><span class="va">p1</span> <span class="op">/</span> <span class="va">p2</span><span class="op">)</span> </span>
<span>        <span class="co"># if (cl %in% c("c2","c5","c6","c7")){</span></span>
<span>        <span class="co">#     lyt &lt;- cl_pt | ((p1 / p2) | patchwork::plot_spacer())   </span></span>
<span>        <span class="co"># }</span></span>
<span>        <span class="va">layout_design</span> <span class="op">&lt;-</span> <span class="va">lyt</span> <span class="op">+</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">layout_design</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">}</span></span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/top3%20marker%20gene-1.png" width="576"><img src="jazzPanda_files/figure-html/top3%20marker%20gene-2.png" width="576"><img src="jazzPanda_files/figure-html/top3%20marker%20gene-3.png" width="576"><img src="jazzPanda_files/figure-html/top3%20marker%20gene-4.png" width="576"><img src="jazzPanda_files/figure-html/top3%20marker%20gene-5.png" width="576"><img src="jazzPanda_files/figure-html/top3%20marker%20gene-6.png" width="576"><img src="jazzPanda_files/figure-html/top3%20marker%20gene-7.png" width="576"><img src="jazzPanda_files/figure-html/top3%20marker%20gene-8.png" width="576"></p>
</div>
<div class="section level5">
<h5 id="visualise-cluster-vector-and-the-top-marker-genes-at-spatial-vector-level-2">Visualise cluster vector and the top marker genes at spatial vector
level<a class="anchor" aria-label="anchor" href="#visualise-cluster-vector-and-the-top-marker-genes-at-spatial-vector-level-2"></a>
</h5>
<p>The figure below shows the relationship between the cluster vector
and the top marker gene vectors detected by linear modelling approach by
accounting for multiple samples and background noise</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">plot_lst</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">cluster_names</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">inters</span><span class="op">=</span><span class="va">tworep_res</span><span class="op">[</span><span class="va">tworep_res</span><span class="op">$</span><span class="va">top_cluster</span><span class="op">==</span><span class="va">cl</span>,<span class="st">"gene"</span><span class="op">]</span></span>
<span>    <span class="va">curr_cell_type</span> <span class="op">=</span> <span class="va">all_celltypes</span><span class="op">[</span><span class="va">all_celltypes</span><span class="op">$</span><span class="va">cluster</span><span class="op">==</span><span class="va">cl</span>,<span class="st">"anno"</span><span class="op">]</span></span>
<span>    <span class="va">rounded_val</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">tworep_res</span><span class="op">[</span><span class="va">inters</span>,<span class="st">"glm_coef"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                            digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>gene<span class="op">=</span><span class="va">inters</span>, value<span class="op">=</span><span class="va">rounded_val</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">=</span><span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span>,<span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>,sep<span class="op">=</span><span class="st">": "</span><span class="op">)</span></span>
<span>        </span>
<span>    <span class="va">mk_gene</span> <span class="op">=</span> <span class="va">inters_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">)</span><span class="op">)</span>,<span class="st">"gene"</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inters</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">dff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">two_rep_vectors</span><span class="op">$</span><span class="va">cluster_mt</span><span class="op">[</span>,<span class="va">cl</span><span class="op">]</span>,</span>
<span>                                    <span class="va">two_rep_vectors</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">[</span>,<span class="va">mk_gene</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dff</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cluster"</span>, <span class="va">mk_gene</span><span class="op">)</span></span>
<span>        <span class="va">total_tiles</span> <span class="op">=</span> <span class="va">grid_length</span> <span class="op">*</span> <span class="va">grid_length</span></span>
<span>        <span class="va">dff</span><span class="op">$</span><span class="va">vector_id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">total_tiles</span><span class="op">)</span></span>
<span>        <span class="va">dff</span><span class="op">$</span><span class="va">sample</span><span class="op">=</span> <span class="st">"Replicate1"</span></span>
<span>        <span class="va">dff</span><span class="op">[</span><span class="op">(</span><span class="va">total_tiles</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">total_tiles</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span>,<span class="st">"sample"</span><span class="op">]</span> <span class="op">=</span> <span class="st">"Replicate2"</span></span>
<span>        <span class="va">dff</span><span class="op">$</span><span class="va">vector_id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">total_tiles</span>, <span class="fl">1</span><span class="op">:</span><span class="va">total_tiles</span><span class="op">)</span></span>
<span>        <span class="va">long_df</span> <span class="op">&lt;-</span> <span class="va">dff</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cluster</span>, <span class="va">sample</span>, <span class="va">vector_id</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"gene"</span>, </span>
<span>                        values_to <span class="op">=</span> <span class="st">"vector_count"</span><span class="op">)</span></span>
<span>        <span class="va">long_df</span><span class="op">$</span><span class="va">gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">long_df</span><span class="op">$</span><span class="va">gene</span>, levels<span class="op">=</span><span class="va">mk_gene</span><span class="op">)</span></span>
<span>        <span class="va">p</span><span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">long_df</span>, </span>
<span>                        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cluster</span>, y <span class="op">=</span> <span class="va">vector_count</span>, color <span class="op">=</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span> size<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">gene</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"cluster vector "</span>, <span class="va">curr_cell_type</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>, </span>
<span>                    y <span class="op">=</span> <span class="st">"marker gene vectors"</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                        override.aes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">rel</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    axis.line<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialFeatureExperiment/man/unit-SpatialFeatureExperiment-method.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>                    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                    axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    axis.ticks<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>                    panel.border <span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                                fill<span class="op">=</span><span class="cn">NA</span>, linewidth<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>        <span class="va">plot_lst</span><span class="op">[[</span><span class="va">cl</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">p</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">combined_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">plot_lst</span>, </span>
<span>                            ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                            common.legend <span class="op">=</span> <span class="cn">TRUE</span>, legend <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_plot</span> </span></code></pre></div>
<p><img src="jazzPanda_files/figure-html/vvplot_twosample-1.png" width="768"></p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.4.2 (2024-10-31)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 22.04.5 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">##  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">## [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] ggpubr_0.6.0                tidyr_1.3.1                </span></span>
<span><span class="co">##  [3] spatstat_3.3-0              spatstat.linnet_3.2-3      </span></span>
<span><span class="co">##  [5] spatstat.model_3.3-3        rpart_4.1.23               </span></span>
<span><span class="co">##  [7] spatstat.explore_3.3-3      nlme_3.1-166               </span></span>
<span><span class="co">##  [9] spatstat.random_3.3-2       spatstat.geom_3.3-4        </span></span>
<span><span class="co">## [11] spatstat.univar_3.1-1       spatstat.data_3.1-4        </span></span>
<span><span class="co">## [13] gridExtra_2.3               ggrepel_0.9.6              </span></span>
<span><span class="co">## [15] ggraph_2.2.1                igraph_2.1.1               </span></span>
<span><span class="co">## [17] corrplot_0.95               caret_6.0-94               </span></span>
<span><span class="co">## [19] lattice_0.22-6              glmnet_4.1-8               </span></span>
<span><span class="co">## [21] Matrix_1.7-1                dplyr_1.1.4                </span></span>
<span><span class="co">## [23] data.table_1.16.2           jazzPanda_0.99.1           </span></span>
<span><span class="co">## [25] ggplot2_3.5.1               SpatialExperiment_1.16.0   </span></span>
<span><span class="co">## [27] SingleCellExperiment_1.28.1 SummarizedExperiment_1.36.0</span></span>
<span><span class="co">## [29] Biobase_2.66.0              GenomicRanges_1.58.0       </span></span>
<span><span class="co">## [31] GenomeInfoDb_1.42.0         IRanges_2.40.0             </span></span>
<span><span class="co">## [33] S4Vectors_0.44.0            BiocGenerics_0.52.0        </span></span>
<span><span class="co">## [35] MatrixGenerics_1.18.0       matrixStats_1.4.1          </span></span>
<span><span class="co">## [37] Seurat_5.1.0                SeuratObject_5.0.2         </span></span>
<span><span class="co">## [39] sp_2.1-4                   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] fs_1.6.5                spatstat.sparse_3.1-0   lubridate_1.9.3        </span></span>
<span><span class="co">##   [4] doParallel_1.0.17       httr_1.4.7              RColorBrewer_1.1-3     </span></span>
<span><span class="co">##   [7] tools_4.4.2             sctransform_0.4.1       backports_1.5.0        </span></span>
<span><span class="co">##  [10] utf8_1.2.4              R6_2.5.1                lazyeval_0.2.2         </span></span>
<span><span class="co">##  [13] uwot_0.2.2              mgcv_1.9-1              withr_3.0.2            </span></span>
<span><span class="co">##  [16] progressr_0.15.1        cli_3.6.3               textshaping_0.4.0      </span></span>
<span><span class="co">##  [19] fastDummies_1.7.4       labeling_0.4.3          sass_0.4.9             </span></span>
<span><span class="co">##  [22] ggridges_0.5.6          pbapply_1.7-2           pkgdown_2.1.1          </span></span>
<span><span class="co">##  [25] systemfonts_1.1.0       parallelly_1.39.0       generics_0.1.3         </span></span>
<span><span class="co">##  [28] shape_1.4.6.1           ica_1.0-3               car_3.1-3              </span></span>
<span><span class="co">##  [31] fansi_1.0.6             abind_1.4-8             lifecycle_1.0.4        </span></span>
<span><span class="co">##  [34] yaml_2.3.10             carData_3.0-5           recipes_1.1.0          </span></span>
<span><span class="co">##  [37] SparseArray_1.6.0       Rtsne_0.17              grid_4.4.2             </span></span>
<span><span class="co">##  [40] promises_1.3.2          crayon_1.5.3            miniUI_0.1.1.1         </span></span>
<span><span class="co">##  [43] cowplot_1.1.3           magick_2.8.5            pillar_1.9.0           </span></span>
<span><span class="co">##  [46] knitr_1.49              rjson_0.2.23            future.apply_1.11.3    </span></span>
<span><span class="co">##  [49] codetools_0.2-20        leiden_0.4.3.1          glue_1.8.0             </span></span>
<span><span class="co">##  [52] vctrs_0.6.5             png_0.1-8               spam_2.11-0            </span></span>
<span><span class="co">##  [55] gtable_0.3.6            cachem_1.1.0            gower_1.0.1            </span></span>
<span><span class="co">##  [58] xfun_0.49               S4Arrays_1.6.0          mime_0.12              </span></span>
<span><span class="co">##  [61] prodlim_2024.06.25      tidygraph_1.3.1         survival_3.7-0         </span></span>
<span><span class="co">##  [64] timeDate_4041.110       iterators_1.0.14        hardhat_1.4.0          </span></span>
<span><span class="co">##  [67] lava_1.8.0              fitdistrplus_1.2-1      ROCR_1.0-11            </span></span>
<span><span class="co">##  [70] ipred_0.9-15            RcppAnnoy_0.0.22        BumpyMatrix_1.14.0     </span></span>
<span><span class="co">##  [73] bslib_0.8.0             irlba_2.3.5.1           KernSmooth_2.23-24     </span></span>
<span><span class="co">##  [76] colorspace_2.1-1        nnet_7.3-19             tidyselect_1.2.1       </span></span>
<span><span class="co">##  [79] compiler_4.4.2          desc_1.4.3              DelayedArray_0.32.0    </span></span>
<span><span class="co">##  [82] plotly_4.10.4           scales_1.3.0            lmtest_0.9-40          </span></span>
<span><span class="co">##  [85] stringr_1.5.1           digest_0.6.37           goftest_1.2-3          </span></span>
<span><span class="co">##  [88] spatstat.utils_3.1-1    rmarkdown_2.29          XVector_0.46.0         </span></span>
<span><span class="co">##  [91] htmltools_0.5.8.1       pkgconfig_2.0.3         fastmap_1.2.0          </span></span>
<span><span class="co">##  [94] rlang_1.1.4             htmlwidgets_1.6.4       UCSC.utils_1.2.0       </span></span>
<span><span class="co">##  [97] shiny_1.9.1             farver_2.1.2            jquerylib_0.1.4        </span></span>
<span><span class="co">## [100] zoo_1.8-12              jsonlite_1.8.9          BiocParallel_1.40.0    </span></span>
<span><span class="co">## [103] ModelMetrics_1.2.2.2    magrittr_2.0.3          Formula_1.2-5          </span></span>
<span><span class="co">## [106] GenomeInfoDbData_1.2.13 dotCall64_1.2           patchwork_1.3.0        </span></span>
<span><span class="co">## [109] munsell_0.5.1           Rcpp_1.0.13-1           viridis_0.6.5          </span></span>
<span><span class="co">## [112] reticulate_1.40.0       stringi_1.8.4           pROC_1.18.5            </span></span>
<span><span class="co">## [115] zlibbioc_1.52.0         MASS_7.3-61             plyr_1.8.9             </span></span>
<span><span class="co">## [118] parallel_4.4.2          listenv_0.9.1           deldir_2.0-4           </span></span>
<span><span class="co">## [121] graphlayouts_1.2.1      splines_4.4.2           tensor_1.5             </span></span>
<span><span class="co">## [124] ggsignif_0.6.4          RcppHNSW_0.6.0          reshape2_1.4.4         </span></span>
<span><span class="co">## [127] evaluate_1.0.1          foreach_1.5.2           tweenr_2.0.3           </span></span>
<span><span class="co">## [130] httpuv_1.6.15           RANN_2.6.2              purrr_1.0.2            </span></span>
<span><span class="co">## [133] polyclip_1.10-7         future_1.34.0           scattermore_1.2        </span></span>
<span><span class="co">## [136] ggforce_0.4.2           broom_1.0.7             xtable_1.8-4           </span></span>
<span><span class="co">## [139] RSpectra_0.16-2         rstatix_0.7.2           later_1.4.1            </span></span>
<span><span class="co">## [142] viridisLite_0.4.2       class_7.3-22            ragg_1.3.3             </span></span>
<span><span class="co">## [145] tibble_3.2.1            memoise_2.0.1           cluster_2.1.6          </span></span>
<span><span class="co">## [148] timechange_0.3.0        globals_0.16.3</span></span></code></pre>
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Melody Jin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
